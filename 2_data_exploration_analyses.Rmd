---
title: "Data exploration and cleaning"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

This notebook performs a basic overview of the data and analyses the genetic diversity indicators. It uses as input the "clean kobo output" that was first cleaned by `1.2_cleaning`.

## Get data

Load required libraries:

```{r, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
library(utile.tools)
library(stringr)
library(ggplot2)
library(ggsankey)
library(alluvial)
```

Load required functions. These custom fuctions are available at: https://github.com/AliciaMstt/GeneticIndicators

```{r}
source("get_indicator1_data.R")
source("get_indicator2_data.R")
source("get_indicator3_data.R")
source("get_metadata.R")
```


Get indicator 1 and indicator 2 data from clean kobo output
```{r}
# Get data:
kobo_clean<-read.csv(file="kobo_output_clean.csv", header=TRUE)

# Extract indicator 1 data from kobo output, show most relevant columns
ind1_data<-get_indicator1_data(kobo_output=kobo_clean)
head(ind1_data[,c(1:3, 12:14)])

# Extract indicator 2 data from kobo output, show most relevant columns
ind2_data<-get_indicator2_data(kobo_output=kobo_clean)
head(ind2_data[,c(1:3, 9:10,13)])

# Extract indicator 3 data from kobo output, show most relevant columns
ind3_data<-get_indicator3_data(kobo_output=kobo_clean)
head(ind3_data[,c(1:3, 9:11)])

# extract metadata, show most relevant columns
metadata<-get_metadata(kobo_output=kobo_clean)
head(metadata[,c(1:3, 12, 25,26)])

```


## General description of the dataset

### Total number of taxa and taxa assessed more than once.

Records by country, including taxa assessed more than once (see below for details on this)

```{r}
ggplot(metadata, aes(x=country_assessment)) + 
  geom_bar(stat = "count") +
  ggtitle("Number of taxa assessedd by country, including duplicated taxa")

```

Records by taxonomic groups

```{r}
ggplot(metadata, aes(x=taxonomic_group)) + 
  geom_bar(stat = "count") +
  theme(axis.text.x = element_text(angle = 45)) +
  ggtitle("Number of taxa assessedd by taxonomic group, including duplicated taxa")

```

Some taxa were assessed twice, for example to account for uncertainty on how to divide populations.

Check how many taxa were analysed twice:

```{r}
# object with duplicated taxa
metadata_duplicates<-metadata[duplicated(metadata$taxon), ]

# how many?
nrow(metadata_duplicates)
```

How many unique?

```{r}
# object with unique taxa
metadata_unique<-metadata[!duplicated(metadata$taxon), ]

# how many?
nrow(metadata_unique)
```


Of which countries and taxonomic groups are the taxa that were assessed more than once?
```{r}
ggplot(metadata_duplicates, aes(x=country_assessment)) + 
  geom_bar(stat = "count") +
  ggtitle("Number of taxa assessed more than once, by country")

```

```{r}
ggplot(metadata_duplicates, aes(x=taxonomic_group, fill=country_assessment)) + 
  geom_bar(stat = "count") +
  theme(axis.text.x = element_text(angle = 45)) +
  ggtitle("Number of taxa assessed more than once")

```

**Now check taxa assessed excluding duplicates, i.e. the real number of taxa assessed. This will be used in downstream analyses**

```{r}
ggplot(metadata_unique, aes(x=country_assessment)) + 
  geom_bar(stat = "count") +
  ggtitle("Number of taxa assessed by country")

```

```{r}
ggplot(metadata_unique, aes(x=taxonomic_group)) + 
  geom_bar(stat = "count") +
  theme(axis.text.x = element_text(angle = 45)) +
  ggtitle("Number of taxa assessed by taxonomic group")

```


### Sankey fun

Which taxonomic groups are countries assesing?
```{r}
library(ggsankey)

# transform data to how ggsankey wants it
df <- metadata %>%
  make_long(country_assessment, taxonomic_group)
df


# Sankey plot
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              node.color = NA,
              show.legend = FALSE) +
  geom_sankey_label(size = 2, color = 1, fill = "white") +
  # colour by country
  scale_fill_manual(values=c(scales::hue_pal()(length(unique(metadata$country_assessment))),  # a nice  color for each of the n countries
                             rep("darkgrey", length(unique(metadata$taxonomic_group)))), # grey for the n taxonomic groups
                    breaks=c(unique(metadata$country_assessment), 
                             unique(metadata$taxonomic_group))) +
  theme_sankey(base_size = 10) +
  xlab("")
  

```


How is the distribution of Ne / Nc data across countries?
```{r}
# transform data to how ggsankey wants it
df <- metadata %>%
  make_long(country_assessment, popsize_data)
df

# Sankey plot
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              node.color = NA,
              show.legend = FALSE) +
  geom_sankey_label(size = 2, color = 1, fill = "white") +
  # colour by country
  scale_fill_manual(values=c(scales::hue_pal()(length(unique(metadata$country_assessment))),  # a nice  color for each of the n countries
                             rep("darkgrey", length(unique(metadata$popsize_data)))), # grey for the n taxonomic groups
                    breaks=c(unique(metadata$country_assessment), 
                             unique(metadata$popsize_data))) +
  theme_sankey(base_size = 10) +
  xlab("")
  
```


How is Ne / Nc  data distributred across countries and speices?
```{r}
# transform data to how ggsankey wants it
df <- metadata %>%
  make_long(country_assessment, taxonomic_group, popsize_data)
df

# Sankey
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              node.color = NA,
              show.legend = FALSE) +
  geom_sankey_label(size = 2, color = 1, fill = "white") +
  theme_sankey(base_size = 10) +
  xlab("")

```
Taxonomic groups and IUCN status


```{r}
# transform data to how ggsankey wants it
df <- metadata %>%
  make_long(taxonomic_group, global_IUCN, popsize_data)
df

# Sankey
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              node.color = NA,
              show.legend = FALSE) +
  geom_sankey_label(size = 2, color = 1, fill = "white") +
  theme_sankey(base_size = 10) +
  xlab("")
```


## Estimate indicator 1

## Estimate indicator 2

## Estimate indicator 3


## Session Info for reproducibility purposes:

```{r}
sessionInfo()
```

