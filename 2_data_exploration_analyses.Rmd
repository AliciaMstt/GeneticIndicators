---
title: "Data exploration and analyses"
output:
  html_document:
    df_print: paged
    toc: true
  word_document: default
  pdf_document: default
---

```{r global-options, include=FALSE}
# options when we want to knit only showing text, results and plots: ie no code, warnings etc.
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE) 
```


This notebook performs a basic overview of the data and analyses the genetic diversity indicators. It uses as input the "clean kobo output" that was first cleaned by `1.2_cleaning`.

## Get data and functions

Load required libraries:

```{r, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
library(utile.tools)
library(stringr)
library(ggplot2)
library(ggsankey)
library(alluvial)
library(viridis)
library(cowplot)
```

Load required functions. These custom fuctions are available at: https://github.com/AliciaMstt/GeneticIndicators

```{r}
source("get_indicator1_data.R")
source("get_indicator2_data.R")
source("get_indicator3_data.R")
source("get_metadata.R")
```

Other custom functions:
```{r}
# to imitate ggplot colors, thanks to https://stackoverflow.com/questions/8197559/emulate-ggplot2-default-color-palette
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

# not in
'%!in%' <- function(x,y)!('%in%'(x,y))
```

Custom colors:
```{r}
## IUCN official colors
IUCNcolors<-c("brown2", "darkgrey", "darkorange", "darkgreen", "bisque1", "green", "azure2", "yellow")

## nice soft ramp for taxonomic groups
taxoncolors<-cividis(12) # same than using cividis(length(levels(as.factor(metadata$taxonomic_group))))

## Colors for simplified methods to define populations 
# assuming the following (see below, it wont work here): levels(as.factor(ind2_data$defined_populations_simplified))
# [1] "adaptive_traits management_units"         "eco_biogeo_proxies"                       "genetic_clusters"                        
# [4] "genetic_clusters eco_biogeo_proxies"      "genetic_clusters geographic_boundaries"   "geographic_boundaries"                   
# [7] "geographic_boundaries adaptive_traits"    "geographic_boundaries eco_biogeo_proxies" "geographic_boundaries management_units"  
# [10] "low_freq_combinations"                    "management_units"                         "other"  
# get a set of colors to highlight genetic and geographic with similar colors

simplifiedmethods_colors<-c("#b34656", #"adaptive_traits management_units"
                            "#7f611b", # "eco_biogeo_proxies"
                            "#668cd1", # "genetic_clusters"     
                            "#5081db", # "genetic_clusters eco_biogeo_proxies"     
                            "#45c097", # "genetic_clusters geographic_boundaries"  
                            "#d4b43e", # "geographic_boundaries"                   
                            "#e38a36", # "geographic_boundaries adaptive_traits"
                            "#d1a16b", # "geographic_boundaries eco_biogeo_proxies"
                            "#d9aa69", # "geographic_boundaries management_units"  
                            "#be72c9", # "low_freq_combinations" 
                            "#b93921", # "management_units" 
                            "#d868a2")# "other" 
  
```


Get indicators data from clean kobo output
```{r, echo=TRUE}
# Get data:
kobo_clean<-read.csv(file="kobo_output_clean.csv", header=TRUE)

# Extract indicator 1 data from kobo output, show most relevant columns
ind1_data<-get_indicator1_data(kobo_output=kobo_clean)
head(ind1_data[,c(1:3, 12:14)])

# Extract indicator 2 data from kobo output, show most relevant columns
ind2_data<-get_indicator2_data(kobo_output=kobo_clean)
head(ind2_data[,c(1:3, 9:10,13)])

# Extract indicator 3 data from kobo output, show most relevant columns
ind3_data<-get_indicator3_data(kobo_output=kobo_clean)
head(ind3_data[,c(1:3, 9:11)])

# extract metadata, show most relevant columns
metadata<-get_metadata(kobo_output=kobo_clean)
head(metadata[,c(1:3, 12, 25,26, 64)])


# save processed data
write.csv(ind1_data, "ind1_data.csv", row.names = FALSE, fileEncoding = "UTF-8")
write.csv(ind2_data, "ind2_data.csv", row.names = FALSE, fileEncoding = "UTF-8")
write.csv(ind3_data, "ind3_data.csv", row.names = FALSE, fileEncoding = "UTF-8")
write.csv(metadata, "metadata.csv", row.names = FALSE, fileEncoding = "UTF-8")

```


## General description of the dataset


### Methods to define populations

The methods used to define populations come from a check box question were one or more of the following categories can be selected: genetic_clusters, geographic_boundaries, eco_biogeo_proxies, adaptive_traits, management_units, other. As a consequence any combination of the former can be possible. Leading to the following results:

```{r}
table(ind2_data$defined_populations)
```

It is hard to group the above methods, so we will keep the original groups with n >=19 in the above list, and tag the combinations that appear few times as as "low_freq_combinations".

Which groups have n>=19?
```{r}
x<-as.data.frame(table(ind2_data$defined_populations)[table(ind2_data$defined_populations) >= 19])
colnames(x)[1]<-"method"

x

```


```{r} 
## (CONSIDER ADDING THIS CHUNK TO THE GET_ FUNCTIONS?)
### for ind2_data
ind2_data<- ind2_data %>% 
  mutate(defined_populations_simplified = case_when(
         # if the method is in the list of methods n>=19 then keep it
         defined_populations %in% x$method ~ defined_populations,
         TRUE ~ "low_freq_combinations"))


### for meta
metadata<- metadata %>% 
  mutate(defined_populations_simplified = case_when(
         # if the method is in the list of methods n>=19 then keep it
         defined_populations %in% x$method ~ defined_populations,
         TRUE ~ "low_freq_combinations"))
         
```


Check n for simplified methods:

```{r}
table(ind2_data$defined_populations_simplified)
```

Another option is to highlight if genetic_cluster or geographic_boundaries were used at all, which are the main drivers. This will look like:

```{r}
### for ind2_data
#ind2_data<- ind2_data %>% 
 # mutate(defined_populations_geneticgeo = case_when(
      #### PENDIENTE USE grepl to show TRUE for geo, gen, geo AND gen, others.
    #))
```


Table of equivalences:

```{r}
ind2_data %>% 
       select(defined_populations, defined_populations_simplified) %>% 
       filter(!duplicated(defined_populations))
```


### Total number of taxa and taxa assessed more than once.

Records by country, including taxa assessed more than once (see below for details on this)

```{r, out.width="700px", out.height="400px"}
highlight1<-ggplot(metadata, aes(x=country_assessment)) + 
  geom_bar(stat = "count") +
  ggtitle("Number of taxa assessedd by country, \nincluding duplicated taxa")

highlight1
```

Did countries used kobo or tabular?

```{r, out.width="700px", out.height="400px" }
ggplot(metadata, aes(x=country_assessment, fill=kobo_tabular)) + 
  geom_bar(stat = "count") +
  ggtitle("Number of taxa assessedd by country, \nincluding duplicated taxa")

```

Records by taxonomic groups

```{r, out.width="700px", out.height="400px"}
ggplot(metadata, aes(x=taxonomic_group)) + 
  geom_bar(stat = "count") +
  theme(axis.text.x = element_text(angle = 45)) +
  ggtitle("Number of taxa assessedd by taxonomic group, \nincluding duplicated taxa")

```

Some taxa were assessed twice, for example to account for uncertainty on how to divide populations. This information is stored in variable `multiassessment` of the metadata (created by `get_metadata()`). An example of taxa with multiple assessments:

```{r}
metadata %>%
filter(multiassessment=="multiassessment")  %>%
  select(taxonomic_group, taxon, country_assessment, multiassessment) %>%
  arrange(taxon, country_assessment) %>%
  head()
  
```
In total these are the number or records (assessment) done for both categories:

```{r}
table(metadata$multiassessment)
``` 

The above numbers refer to the number or records, if what we want is to know how many **taxa** were analysed for each category, then:

Number of taxa with multiple submissions:
```{r}
multi_taxa<- metadata %>%
                filter(multiassessment=="multiassessment") %>%
                select(taxon, country_assessment, taxonomic_group) %>%
                unique()
# how many?
nrow(multi_taxa)
```

Number of taxa with single submissions:

```{r}
single_taxa<- metadata %>%
                filter(multiassessment=="single_assessment") %>%
                select(taxon, country_assessment, taxonomic_group) %>%
                unique()
# how many?
nrow(single_taxa)
```

To explore what kind of taxa countries assessed regardless of if they assessed them once or more, lets create a dataset keeping all single assessed taxa, plus only the first assessment for taxa assessed multiple times. 

```{r}
# object with single assessed taxa, plus only the first assessment for taxa assessed multiple times
metadata_firstmulti<-metadata[!duplicated(cbind(metadata$taxon, metadata$country_assessment)), ]

```

How many records?
```{r}
# how many?
nrow(metadata_firstmulti)
```

Of which countries and taxonomic groups are the taxa that were assessed more than once?
```{r}
metadata_firstmulti %>% # we use the _firstmulti dataset so that multiassesed records are counted only once
        filter(multiassessment=="multiassessment") %>%
      ggplot(aes(x=country_assessment)) + 
        geom_bar(stat = "count") +
        ggtitle("Number of taxa assessed more than once, by country")

```

```{r}
highlight2<-metadata_firstmulti %>% # we use the _unique dataset so that multiassesed records are counted only once
        filter(multiassessment=="multiassessment") %>%

ggplot(aes(x=taxonomic_group, fill=country_assessment)) + 
  geom_bar(stat = "count") +
  theme(axis.text.x = element_text(angle = 45)) +
  ggtitle("Number of taxa assessed more than once")
highlight2

```

**Now check taxa assessed excluding duplicates, i.e. the real number of taxa assessed. This will be used in downstream analyses**

```{r, out.width="700px", out.height="400px"}
highlight3<-ggplot(metadata_firstmulti, aes(x=country_assessment)) + 
  geom_bar(stat = "count") +
  ggtitle("Number of taxa assessed by country")
highlight3
```

```{r}
ggplot(metadata_firstmulti, aes(x=taxonomic_group)) + 
  geom_bar(stat = "count") +
  theme(axis.text.x = element_text(angle = 45)) +
  ggtitle("Number of taxa assessed by taxonomic group")

```




### Sankey and alluvial fun

Note: The following plots in this section consider only one record of the taxa that were assessed more than once. That is a total of `r nrow(metadata_firstmulti)` taxa.

#### Which taxonomic groups are countries assessing?

Note on alluvial vs Sankey, taken from ggalluvial: An important feature of alluvial plots is the meaningfulness of the vertical axis: No gaps are inserted between the strata, so the total height of the plot reflects the cumulative quantity of the observations. The plots produced by {ggalluvial} conform to the “grammar of graphics” principles of {ggplot2}, and this prevents users from producing “free-floating” visualizations like the Sankey diagrams

Using alluvial:
```{r, out.width="700px", out.height="500px"}
library(alluvial)
# estimate frequencies for alluvial plot
foralluvial_1<-metadata_firstmulti %>% group_by(country_assessment, taxonomic_group) %>%
             summarise(n=n())
head(foralluvial_1)

## plot
# define colors
my_cols<- gg_color_hue(length(unique(foralluvial_1$country_assessment)))

# we need a vector of colors by country for each row of the dataset, so:
countries<-as.factor(foralluvial_1$country_assessment)
levels(countries)<-my_cols
countries<-as.vector(countries)
head(countries)

# plot
alluvial(foralluvial_1[,1:2], freq = foralluvial_1$n,
         col=countries, 
         blocks=FALSE,
         gap.width = 0.3,
         cex=.8, 
         xw = 0.2,
         cw = 0.1,
         border = NA)

```

Using ggsankey
```{r, out.width="600px", out.height="580px"}
library(ggsankey)

# transform data to how ggsankey wants it
df <- metadata_firstmulti %>%
  make_long(country_assessment, taxonomic_group)

# Sankey plot
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              node.color = NA,
              show.legend = FALSE) +
  geom_sankey_label(size = 2, color = 1, fill = "white") +
  # colour by country
  scale_fill_manual(values=c(scales::hue_pal()(length(unique(metadata$country_assessment))),  # a nice  color for each of the n countries
                             rep("darkgrey", length(unique(metadata$taxonomic_group)))), # grey for the n taxonomic groups
                    breaks=c(unique(metadata$country_assessment), 
                             unique(metadata$taxonomic_group))) +
  theme_sankey(base_size = 10) +
  xlab("")
  

```


####  Ne / Nc data across countries and taxa?

Using alluvial:
```{r, out.width="700px", out.height="500px"}
library(alluvial)
# estimate frequencies for alluvial plot
foralluvial_1<-metadata_firstmulti %>% group_by(country_assessment, taxonomic_group, popsize_data) %>%
             summarise(n=n())
head(foralluvial_1)

## plot
# define colors
my_cols<- gg_color_hue(length(unique(foralluvial_1$country_assessment)))

# we need a vector of colors by country for each row of the dataset, so:
countries<-as.factor(foralluvial_1$country_assessment)
levels(countries)<-my_cols
countries<-as.vector(countries)
head(countries)

# plot (highlight4)
alluvial(foralluvial_1[,1:3], freq = foralluvial_1$n,
         col=countries, 
         blocks=FALSE,
         gap.width = 0.5,
         cex=.8, 
         xw = 0.1,
         cw = 0.2,
         border = NA)

```

Using ggsankey option 1
```{r, out.width="900px", out.height="600px"}
# transform data to how ggsankey wants it
df <- metadata_firstmulti %>%
  make_long(country_assessment, taxonomic_group, popsize_data)

# Sankey
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              show.legend = FALSE) +
  # manually set flow fill according to countries and popsize 
                      # a nice  color for each of the n countries for the first (left) part
  scale_fill_manual(values=c(scales::hue_pal()(length(unique(metadata_firstmulti$country_assessment))),  
                             # grey for the taxonomic groups
                              rep("darkgrey", length(unique(metadata_firstmulti$taxonomic_group))),
                             # three colors for popsize_data
                             c("darkolivegreen", "darkgoldenrod1", "brown3")), 
                    breaks=c(unique(metadata_firstmulti$country_assessment), 
                             unique(metadata_firstmulti$taxonomic_group),
                             unique(metadata_firstmulti$popsize_data))) +

  geom_sankey_label(size = 2, color = 1, fill = "white") +
  theme_sankey(base_size = 10) +
  xlab("")

```

Using ggsankey option 2
```{r, out.width="900px", out.height="600px"}
# transform data to how ggsankey wants it
df <- metadata_firstmulti %>%
  make_long(country_assessment, taxonomic_group, popsize_data)

# Sankey
highlight5<-ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              show.legend = FALSE) +
  # manually set flow fill according to countries and popsize 
                      # a nice  color for each of the n countries for the first (left) part
  scale_fill_manual(values=c(scales::hue_pal()(length(unique(metadata_firstmulti$country_assessment))),  
                             # gradient of soft colors for taxonomic groups
                             taxoncolors,
                             # traffic light for pop data
                             c("darkolivegreen", "darkgoldenrod1", "brown3")), 
                    breaks=c(unique(metadata_firstmulti$country_assessment), 
                             levels(as.factor(metadata_firstmulti$taxonomic_group)),
                             unique(metadata_firstmulti$popsize_data))) +

  geom_sankey_label(size = 2.5, color = "black", fill = "white") +
  theme_sankey(base_size = 10) +
  xlab("")

highlight5

```



#### Taxonomic groups and IUCN status

Using alluvial:
```{r, out.width="900px", out.height="600px"}
library(alluvial)
# estimate frequencies for alluvial plot
foralluvial_1<-metadata_firstmulti %>% group_by(taxonomic_group, global_IUCN, popsize_data) %>%
             summarise(n=n())

## plot
# define colors according to IUCN categories
# check order of categories:
levels(as.factor(metadata_firstmulti$global_IUCN))

# create vector of colors accordingly:
my_cols<-IUCNcolors


# we need a vector of colors by iucn for each row of the dataset, so:
gIUCN<-as.factor(foralluvial_1$global_IUCN)
levels(gIUCN)<-my_cols
gIUCN<-as.vector(gIUCN)
head(gIUCN)

# plot
alluvial(foralluvial_1[,1:3], freq = foralluvial_1$n,
         col=gIUCN, 
         blocks="bookends",
         alpha = 0.6,
         gap.width = 0.4,
         cex=.75, 
         xw = 0.15,
         cw = 0.2,
         border = NA)

```

Using ggsankey

```{r, out.width="900px", out.height="600px"}
# transform data to how ggsankey wants it
df <- metadata %>%
  make_long(taxonomic_group, global_IUCN, popsize_data)


# Sankey
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              node.color = NA,
              show.legend = FALSE) +
  
    # manually set flow fill 
                       # gradient of soft colors for taxonomic groups
  scale_fill_manual(values= c(taxoncolors,
                       # iucn color codes
                           IUCNcolors,
                     # traffic light for pop data
                           c("darkolivegreen", "darkgoldenrod1", "brown3")),
                    breaks=c(levels(as.factor(metadata_firstmulti$taxonomic_group)), 
                             levels(as.factor(metadata_firstmulti$global_IUCN)),
                             unique(metadata_firstmulti$popsize_data))) +

  geom_sankey_label(size = 2, color = 1, fill = "white") +
  theme_sankey(base_size = 10) +
  xlab("")
```



#### Method to define populations

The following plots consider the whole dataset, ie including taxa that were assessed more than once (because they could have been analysed using different methods to define populations)

```{r}
# reformat data
foralluvial<-metadata %>% group_by(country_assessment, defined_populations_simplified, taxonomic_group) %>%
             summarise(n=n())

## plot
# define colors
my_cols<- simplifiedmethods_colors

# we need a vector of colors by country for each row of the dataset, so:
methodspop<-as.factor(foralluvial$defined_populations_simplified)
levels(methodspop)<-my_cols
methodspop<-as.vector(methodspop)
head(methodspop)

# plot
alluvial(foralluvial[,1:3], freq = foralluvial$n,
         col=methodspop, 
         blocks=FALSE,
         gap.width = 0.5,
         cex=.8, 
         xw = 0.1,
         cw = 0.2,
         border = NA,
         alpha = .7)

```

Same only country and method:

```{r}
# plot
alluvial(foralluvial[,1:2], freq = foralluvial$n,
         col=methodspop, 
         blocks=FALSE,
         gap.width = 0.5,
         cex=.8, 
         xw = 0.1,
         cw = 0.2,
         border = NA,
          alpha = .7)

```

Sankey just becasue why not:

```{r}
# transform data to how ggsankey wants it
df <- metadata %>%
  make_long(country_assessment, defined_populations_simplified, taxonomic_group)

# Sankey plot
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.6, 
              node.color = NA,
              show.legend = FALSE) +
  geom_sankey_label(size = 2, color = 1, fill = "white") +
  # colour by country
                              # a nice  color for each of the n countries
  scale_fill_manual(values=c(scales::hue_pal()(length(unique(metadata$country_assessment))),  
                             rep("darkgrey", length(unique(metadata$defined_populations_simplified))),
                             taxoncolors), 
                    breaks=c(unique(metadata$country_assessment), 
                             levels(as.factor(ind2_data$defined_populations_simplified)),
                             levels(as.factor(ind2_data$taxonomic_group)))) +
  theme_sankey(base_size = 10) +
  xlab("")
```




## Indicator 1 (populations Ne > 500)


### Remember population size data could be obtained by different means

Population size data may come from different methods for each population within a single taxon. For example, some populations can have Ne estimates, other Nc and others a range. Examples:

```{r}
ind1_data %>%
  filter(taxon=="Alces alces") %>% 
  select(country_assessment, taxon, population, Name, Ne, NcRange)


ind1_data %>%
  filter(taxon=="Alces alces") %>% 
  select(country_assessment, taxon, population, Name, NcPoint, NcRange)

```


Also, for some taxa there may be population size data for some populations, but not all. Therefore indicator 1 would be computed with less populations than the total number of populations. Example (see pop3, 4, 13, 15):

```{r}
ind1_data %>%
  filter(taxon=="Juniperus monticola") %>% 
  select(country_assessment, taxon, population, Name, Ne, NcPoint, NcRange)
```
We need to keep the former in mind for interpretation and discussion of how the indicator can change in future assessments if data becomes available for populations currently missing.

How many of the `r nrow(ind1_data)` populations have Ne, Nc or range data?

Ne?
```{r}
sum(!is.na(ind1_data$Ne))
```

Nc point?
```{r}
sum(!is.na(ind1_data$NcPoint))
```

Nc range?
```{r}
sum(!is.na(ind1_data$NcRange))
```


Ne data by population
```{r}
ind1_data %>%
  ggplot(aes(x=country_assessment, fill=is.na(Ne)))+
  geom_bar(position = "dodge") +
  coord_flip() + 
  scale_fill_manual(labels=c("no", "yes"),
                      breaks=c("TRUE", "FALSE"),
                      values=c("brown", "darkgreen")) + 
  labs(fill="Population has Ne data?") +
  xlab("") +
  theme_bw() +
  theme(text = element_text(size = 17), legend.position = "bottom", panel.border = element_blank())
```
Nc data type by population

```{r}
ind1_data %>%
  filter(!is.na(NcType)) %>%
  ggplot(aes(x=country_assessment, fill=NcType))+
  geom_bar(position = "dodge") +
  coord_flip() + 
  scale_fill_discrete(labels=c("Nc_point", "Nc_range", "Unknown Nc for this population"),
                     breaks=c("Nc_point", "Nc_range", "unknown")) +
  xlab("") +
  theme_bw() +
  theme(text = element_text(size = 17), legend.position = "bottom", panel.border = element_blank()) +
  labs(fill="") +
  ggtitle("Type of Nc data by population")
```


*By taxa*

Nc data availalbe by taxa?
```{r}
metadata %>%
  filter(!is.na(nc_pops_exists)) %>%
  ggplot(aes(x=country_assessment, fill=nc_pops_exists))+
  geom_bar() +
  coord_flip() + 
  scale_fill_manual(values=c("brown", "darkgreen")) + 
  labs(fill="Has Nc data for indicator 1?") +
  xlab("") +
  ggtitle("Has Nc data?") +
  theme_bw() +
  theme(text = element_text(size = 17), legend.position = "bottom", panel.border = element_blank())
```

Ne data and genetic data available?

```{r}
metadata %>% 
  filter(!is.na(ne_pops_exists)) %>% 
    ggplot(aes(x=country_assessment, fill=ne_pops_exists)) + 
  geom_bar(position = "dodge") +
scale_fill_manual(labels=c("no", "yes", "no, but has genetic data"),
                      breaks=c("no_genetic_data", "ne_available", "other_genetic_info"),
                      values=c("brown", "darkgreen", "grey")) +
  coord_flip()  +
theme_bw() +
theme(text = element_text(size = 17), legend.position = "bottom", panel.border = element_blank()) +
ggtitle("Has Ne data?")
```

Ne data yes or not?

```{r}
metadata %>% 
  filter(!is.na(ne_pops_exists)) %>% 
  filter(ne_pops_exists!="other_genetic_info") %>%
    ggplot(aes(x=country_assessment, fill=ne_pops_exists)) + 
  geom_bar() +
scale_fill_manual(labels=c("no", "yes"),
                      breaks=c("no_genetic_data", "ne_available"),
                      values=c("brown", "darkgreen")) +
  coord_flip()  +
xlab("") +
labs(fill="Has Ne data for indicator 1?")  +
theme_bw() +
theme(text = element_text(size = 17), legend.position = "bottom", panel.border = element_blank()) +
ggtitle("Has Ne data?")
```


### Ne values

How is Ne data distributed? 

```{r}
summary(ind1_data$Ne)
```


Boxplot of Ne values:
```{r}
ind1_data %>%
  ggplot(aes(x=country_assessment, y=Ne)) +
  geom_boxplot()
```
Check outliers (Ne very high):
```{r}
ind1_data %>% 
  filter(Ne > 100000) %>%
  select(country_assessment, name_assessor, taxon, taxonomic_group, Ne, NeLower, NeUpper, multiassessment, population)
```


Boxplot filtering outliers (Ne)
```{r}
ind1_data %>% filter(Ne < 100000) %>%
  ggplot(aes(x=country_assessment, y=Ne)) +
  geom_boxplot()
```



## Indicator 2 (proportion of populations within species which are maintained)

Indicator 2 is the he proportion of populations within species which are maintained. This can be estimated based on the `n_extant_populations` and `n_extint_populations`, as follows:

```{r}
ind2_data$indicator2<- ind2_data$n_extant_populations / (ind2_data$n_extant_populations + ind2_data$n_extint_populations)
head(ind2_data$indicator2)
```


### Number of extant populations.

See the distribution of the number of extant populations:

```{r}
ind2_data %>% 
  ggplot(aes(x=n_extant_populations)) +
  geom_histogram() + 
  ggtitle("histogram of extant populations")
```

Which taxa have more than 100 populations?
```{r}
ind2_data %>% 
  filter(n_extant_populations>100) %>%
  select(taxon, country_assessment, n_extant_populations)
```

Exclude outliers (>200 populations)
```{r}
ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=n_extant_populations)) +
  geom_histogram() + 
  ggtitle("Distribution of extant populations \nexcluding outliers (>200 pops)")

```

How does the number of populations vary by country? (excluding outliers: >200 pops)

```{r}
ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=country_assessment, y=n_extant_populations)) +
          geom_boxplot(aes(color=country_assessment)) +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") + 
  ggtitle("Distribution of extant populations by country, \nexcluding outliers (>200 pops)")


```

And by method to define populations? (excluding outliers: >200 pops)

```{r, out.width=900, out.height=500}
ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=defined_populations, y=n_extant_populations)) +
          geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extant populations by pop definition method, \nexcluding outliers (>200 pops)")

```

Simplified method categories for easier visualization:

```{r, out.width=900, out.height=500}
ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=defined_populations_simplified, y=n_extant_populations, color=defined_populations_simplified)) +
          geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") + 
  ggtitle("Distribution of extant populations by pop definition method, \nexcluding outliers (>200 pops)") +
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified)))
  

```

Number of populations by taxonomic group:
```{r}
ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=taxonomic_group, y=n_extant_populations, color=taxonomic_group)) +
          geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extant populations by taxonomic group, \nexcluding outliers (>200 pops)") +
  scale_color_manual(values= taxoncolors,
                    breaks=levels(levels(as.factor(ind2_data$taxonomic_group))))
```

Taxonomic group and method:
```{r}
ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=taxonomic_group, y=n_extant_populations, color=taxonomic_group)) +
          geom_boxplot() +
          geom_jitter(size=.3, width = 0.1, color="darkred") +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extant populations by taxonomic group and method to define pops, excluding outliers (>200 pops)") +
  scale_color_manual(values= taxoncolors,
                    breaks=levels(levels(as.factor(ind2_data$taxonomic_group)))) +
  facet_wrap(defined_populations_simplified ~ .) +
  xlab("")
```

Country and method:
```{r}
ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=defined_populations_simplified, y=n_extant_populations, color=defined_populations_simplified)) +
          geom_boxplot() +
          geom_jitter(size=.3, width = 0.1, color="black") +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") + 
  ggtitle("Distribution of extant populations by country and \nmethod to define pops, excluding outliers (>200 pops)") +
  facet_wrap(country_assessment ~ ., nrow=2) +
  xlab("")  +
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified)))
```

Country and method, but with the US and Sweden in different scale
```{r}
## excluding Sweden and US
p1<-ind2_data %>% 
  filter(n_extant_populations<50) %>%
  filter(country_assessment!="sweden", country_assessment!="united_states") %>%
  
  # plot
  ggplot(aes(x=defined_populations_simplified, y=n_extant_populations, color=defined_populations_simplified)) +
          geom_boxplot() +
          geom_jitter(size=.3, width = 0.1, color="black") +
  coord_flip() +
  theme_bw() + ylab("") +
  theme(panel.border = element_blank(), legend.position="none") + 
  ggtitle("Distribution of extant populations by country and method to define pops, excluding outliers (>200 pops)") +
  facet_wrap(country_assessment ~ ., nrow=2) +
  xlab("")  +
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified)))

## With Sweden and US
p2<-ind2_data %>% 
  filter(n_extant_populations<200) %>%
  filter(country_assessment %in% c("sweden", "united_states")) %>%
  
  # plot
  ggplot(aes(x=defined_populations_simplified, y=n_extant_populations, color=defined_populations_simplified)) +
          geom_boxplot() +
          geom_jitter(size=.3, width = 0.1, color="black") +
  coord_flip() +
  theme_bw() + xlab("") + ylab("Number of extant populations") +
  theme(panel.border = element_blank(), legend.position="none") + 
  facet_wrap(country_assessment ~ ., nrow=1, ncol=2) +
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified)))
  ## plot together
plot_grid(p1, p2, nrow=2, rel_heights = c(2,1))
  
```



Number of populations by taxonomic group and range type:
```{r}
# add species range metadata
ind2_data$species_range <- metadata$species_range

ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=taxonomic_group, y=n_extant_populations, color=species_range)) +
          geom_boxplot() +
          geom_jitter(size=.3, position = position_jitterdodge()) +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extant populations by taxonomic group and range, \nexcluding outliers (>200 pops)")
```

Number of populations by taxonomic group and global IUCN:
```{r}
# add species range metadata
ind2_data$global_IUCN <- metadata$global_IUCN

ind2_data %>% 
  filter(n_extant_populations<200) %>%
  ggplot(aes(x=taxonomic_group, y=n_extant_populations, col=global_IUCN)) +
          geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extant populations by taxonomic group and global IUCN, \nexcluding outliers (>200 pops)") +
  scale_color_manual(values= IUCNcolors, # iucn color codes
                    breaks=c(levels(as.factor(ind2_data$global_IUCN))))
```

### ANOVAS on the number of extant populations

One-way ANOVA for the effect of the **method to define populations** on the number of extant pops, removing the extreme outlier (>1,000 pops)

```{r, echo=TRUE, message=TRUE}
# subset data without massive outlier
ind2_data_anova<- ind2_data %>% 
                         filter(n_extant_populations<1000)

# summary of n per variable
table(ind2_data_anova$defined_populations_simplified)

# One way ANOVA method
res.anova.extant<-aov(n_extant_populations ~ defined_populations_simplified, data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Same One-way ANOVA for the effect of the **method to define populations** on the number of extant pops, but removing outliers >200 pops

```{r, echo=TRUE, message=TRUE}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
                         filter(n_extant_populations<200)

# summary of n per variable
table(ind2_data_anova$defined_populations_simplified)

# One way ANOVA method
res.anova.extant<-aov(n_extant_populations ~ defined_populations_simplified, data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


One-way ANOVA for the effect of the **country** on the number of extant pops, removing outliers >200 pops

```{r, echo=TRUE, message=TRUE}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
                         filter(n_extant_populations<200)

# summary of n per variable
table(ind2_data_anova$country_assessment)

# One way ANOVA method
res.anova.extant<-aov(n_extant_populations ~ country_assessment, data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


One-way ANOVA for the effect of the **taxonomic group** on the number of extant pops, removing outliers >200 pops and taxonomic groups with too few data

```{r, echo=TRUE, message=TRUE}
# summary of n per variable
table(ind2_data$taxonomic_group)

# subset data 
ind2_data_anova<- ind2_data %>% 
                         filter(n_extant_populations<200) %>% 
                         filter(taxonomic_group %!in% c("fungus", "bryophyte", "other", "pteridophytes"))

# summary of n per variable
table(ind2_data_anova$taxonomic_group)

# One way ANOVA method
res.anova.extant<-aov(n_extant_populations ~ taxonomic_group, data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```

Two-way ANOVA with interaction effect of the method to define populations and the country, removing outliers >200 pops
**Question: is interaction he correct model? or should it be additive?**

```{r}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
                         filter(n_extant_populations<200)

# summary of n per variable
ind2_data_anova %>%
  group_by(country_assessment, defined_populations_simplified) %>% summarise(n=n())

# Two-way ANOVA with interaction effect of the method to define populations and the country
res.anova.extant<-aov(n_extant_populations ~ defined_populations_simplified * country_assessment , data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)

```
Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


Two-way ANOVA with interaction effect of the method to define populations and the country, but keeping only groups with enough n
```{r, echo=TRUE, message=TRUE}
# variables with enough n
enough_n<-ind2_data %>%
              group_by(country_assessment, defined_populations_simplified) %>% 
              summarise(n=n()) %>% 
              filter(n>=15)


# subset data without outliers and with enough n
ind2_data_anova<- ind2_data %>% 
                  filter(n_extant_populations<200) %>% 
                                # this gives the country
                  filter(country_assessment==unique(enough_n$country_assessment)[1] & 
                                 #this gives the methods for that country (the last [[1]] is to get the results out of a list)
                  defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[1], 2][[1]]  | 
                                
                  # the same for rest of countries. Notice the use of & for methods within country and | to change to other country
                  country_assessment==unique(enough_n$country_assessment)[2] & 
                  defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[2], 2][[1]] | 
                    
                  country_assessment==unique(enough_n$country_assessment)[3] & 
                  defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[3], 2][[1]] |
                    
                  country_assessment==unique(enough_n$country_assessment)[4] & 
                  defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[4], 2][[1]] | 
                    
                  country_assessment==unique(enough_n$country_assessment)[5] & 
                  defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[5], 2][[1]] | 
                    
                  country_assessment==unique(enough_n$country_assessment)[6] & 
                  defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[6], 2][[1]] | 
                    
                  country_assessment==unique(enough_n$country_assessment)[7] & 
                  defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[7], 2][[1]] | 
                    
                  country_assessment==unique(enough_n$country_assessment)[8] & 
                  defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[8], 2][[1]])

# summary of n per variable
ind2_data_anova %>%
  group_by(country_assessment, defined_populations_simplified) %>% summarise(n=n())

# Two-way ANOVA with interaction effect of the method to define populations and the country
res.anova.extant<-aov(n_extant_populations ~ defined_populations_simplified * country_assessment , data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```
Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


### Number of extinct populations.

See the distribution of the number of extinct populations:
  
```{r}
ind2_data %>% 
  ggplot(aes(x=n_extint_populations)) +
  geom_histogram() + 
  ggtitle("histogram of extinct populations")
```

Exclude outliers (>200 populations)
```{r}
ind2_data %>% 
  filter(n_extint_populations<200) %>%
  ggplot(aes(x=n_extint_populations)) +
  geom_histogram() + 
  ggtitle("Distribution of extinct populations \nexcluding outliers (>200 pops)")

```

How does the number of populations vary by country? (excluding outliers: >200 pops)

```{r}
ind2_data %>% 
  filter(n_extint_populations<200) %>%
  ggplot(aes(x=country_assessment, y=n_extint_populations)) +
  geom_boxplot(aes(color=country_assessment)) +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") + 
  ggtitle("Distribution of extinct populations by country, \nexcluding outliers (>200 pops)")


```

by method to define populations? (excluding outliers: >200 pops) with simplified method categories for easier visualization:
  
```{r, out.width=900, out.height=500}
ind2_data %>% 
  filter(n_extint_populations<200) %>%
  ggplot(aes(x=defined_populations_simplified, y=n_extint_populations, color=defined_populations_simplified)) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") + 
  ggtitle("Distribution of extinct populations by pop definition method, \nexcluding outliers (>200 pops)") +
  scale_color_manual(values=simplifiedmethods_colors,
                     breaks=levels(as.factor(ind2_data$defined_populations_simplified)))

```

Number of populations by taxonomic group:
```{r}
ind2_data %>% 
  filter(n_extint_populations<200) %>%
  ggplot(aes(x=taxonomic_group, y=n_extint_populations, color=taxonomic_group)) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extinct populations by taxonomic group, \nexcluding outliers (>200 pops)") +
  scale_color_manual(values= taxoncolors,
                     breaks=levels(levels(as.factor(ind2_data$taxonomic_group))))
```

Taxonomic group and method:
```{r}
ind2_data %>% 
  filter(n_extint_populations<200) %>%
  ggplot(aes(x=taxonomic_group, y=n_extint_populations, color=taxonomic_group)) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extinct populations by taxonomic group and \nmethod to define pops, excluding outliers (>200 pops)") +
  scale_color_manual(values= taxoncolors,
                     breaks=levels(levels(as.factor(ind2_data$taxonomic_group)))) +
  facet_wrap(defined_populations_simplified ~ .) +
  xlab("")
```

Country and method:
```{r}
ind2_data %>% 
  filter(n_extint_populations<200) %>%
  ggplot(aes(x=defined_populations_simplified, y=n_extint_populations, color=defined_populations_simplified)) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") + 
  ggtitle("Distribution of extinct populations by country and \nmethod to define pops, excluding outliers (>200 pops)") +
  facet_wrap(country_assessment ~ ., nrow=2) +
  xlab("")  +
  scale_color_manual(values=simplifiedmethods_colors,
                     breaks=levels(as.factor(ind2_data$defined_populations_simplified)))
```

Number of populations by taxonomic group and range type:
```{r}
# add species range metadata
ind2_data$species_range <- metadata$species_range

ind2_data %>% 
  filter(n_extint_populations<200) %>%
  ggplot(aes(x=taxonomic_group, y=n_extint_populations, color=species_range)) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extinct populations by taxonomic group and range, \nexcluding outliers (>200 pops)")
```

Number of populations by taxonomic group and global IUCN:
```{r}
# add species range metadata
ind2_data$global_IUCN <- metadata$global_IUCN

ind2_data %>% 
  filter(n_extint_populations<200) %>%
  ggplot(aes(x=taxonomic_group, y=n_extint_populations, col=global_IUCN)) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank()) + 
  ggtitle("Distribution of extinct populations by taxonomic group and global IUCN, \nexcluding outliers (>200 pops)") +
  scale_color_manual(values= IUCNcolors, # iucn color codes
                     breaks=c(levels(as.factor(ind2_data$global_IUCN))))
```

### Numberof extant vs extinct number of populations

By method
```{r}
ind2_data %>%
  # filter outliers with too many pops
  filter(n_extant_populations<200) %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=n_extint_populations, color=defined_populations_simplified)) +
    geom_point() +
    theme_bw() +
    scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified))) 
```

By method. Sweden and US separately because they have too many pops.
```{r, out.height="600px", out.width="600px"}
## excluding Sweden and US

p1 <- ind2_data %>%
  # filter outliers with too many pops and desired countries
  filter(n_extant_populations<50) %>%
  filter(country_assessment!="sweden", country_assessment!="united_states") %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=n_extint_populations, color=defined_populations_simplified)) +
    geom_point() + theme_bw() + xlab("") +
    scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified))) + facet_wrap(country_assessment ~ ., nrow=2) +
   theme(panel.border = element_blank(), legend.position="none")

## With Sweden and US
p2<-ind2_data %>%
  # filter outliers with too many pops and desired countries
  filter(n_extant_populations<200) %>%
  filter(country_assessment %in% c("sweden", "united_states")) %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=n_extint_populations, color=defined_populations_simplified)) +
    geom_point() + theme_bw() +
    scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified))) + facet_wrap(country_assessment ~ ., nrow=1, ncol=2) +
   theme(panel.border = element_blank(), legend.position="bottom")

## plot together
plot_grid(p1, p2, nrow=2, rel_heights = c(1.2,1))
```
By risk status, zooming in to fewer n of pops. Sweden and US separately because they have too many pops.

```{r, out.height="600px", out.width="600px"}
## excluding Sweden and US

p1 <- ind2_data %>%
  # filter outliers with too many pops and desired countries
  filter(n_extant_populations<50) %>%
  filter(country_assessment!="sweden", country_assessment!="united_states") %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=n_extint_populations, color=global_IUCN)) +
    geom_point() + theme_bw() + xlab("") +
    scale_color_manual(values=IUCNcolors,
                    breaks=levels(as.factor(ind2_data$global_IUCN))) + facet_wrap(country_assessment ~ ., nrow=2) +
   theme(panel.border = element_blank(), legend.position="none")

## With Sweden and US
p2<-ind2_data %>%
  # filter outliers with too many pops and desired countries
  filter(n_extant_populations<200) %>%
  filter(country_assessment %in% c("sweden", "united_states")) %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=n_extint_populations, color=global_IUCN)) +
    geom_point() + theme_bw() +
    scale_color_manual(values=IUCNcolors,
                    breaks=levels(as.factor(ind2_data$global_IUCN))) + facet_wrap(country_assessment ~ ., nrow=1, ncol=2) +
   theme(panel.border = element_blank(), legend.position="bottom")

## plot together
plot_grid(p1, p2, nrow=2, rel_heights = c(1.2,1))
```


### Distribution of NA in indicator 2

We have NA because in some cases the number of extinct populations is unknown, therefore the above operation cannot be computed. 

Total records with NA in extant populations:
```{r}
sum(is.na(ind2_data$n_extant_populations))
```

Which are?
```{r}
ind2_data %>%
  filter(is.na(n_extant_populations)) %>%
    select(country_assessment, taxonomic_group, taxon, n_extant_populations, n_extint_populations)
```

Total taxa with NA in **extinct** populations:
```{r}
sum(is.na(ind2_data$n_extint_populations))
```

Do taxa with NA for extant also have NA for extinct?

```{r}
ind2_data$taxon[is.na(ind2_data$n_extant_populations)] %in% ind2_data$taxon[is.na(ind2_data$n_extint_populations)]
```

So out of the `r nrow(ind2_data)`, we have **`r sum(is.na(ind2_data$n_extint_populations))` records with NA in n_extinct** and **`r sum(is.na(ind2_data$n_extant_populations))` records with NA in n_extant**. Of them, `r sum(ind2_data$taxon[is.na(ind2_data$n_extant_populations)] %in% ind2_data$taxon[is.na(ind2_data$n_extint_populations)])` have NA in both n_extant and n_extinct.

**QUESTION: should we manually check that NA are correct in both extinct or extant pops? (the cleaning script only chekcs for 0, not NAs)**

So in total there are `r sum(is.na(ind2_data$indicator2))` records where there are NA in either n_extant or n_extinct, which is `r round(sum(is.na(ind2_data$indicator2))/nrow(ind2_data)*100, 2)`% of total number of records. Therefore when estimating indicator 2... **QUESTION: What should we do: A) we can’t estimate indicator 2 in those species, or B) we assume n_extinct = NA = 0, and therefore indicator 2 = 1.**

##### Plots!

By country
```{r}
ind2_data %>%
  ggplot(aes(x=country_assessment, fill=is.na(indicator2)))+
  geom_bar(position = "dodge") +
  coord_flip() + 
  scale_fill_discrete(labels=c("number of population known", "has missing data")) + 
  labs(fill="Indicator 2 data") +
  xlab("")
  
```

By taxonomic group
```{r}
ind2_data %>%
  ggplot(aes(x=taxonomic_group, fill=is.na(indicator2)))+
  geom_bar(position = "dodge") +
  coord_flip()+ 
  scale_fill_discrete(labels=c("number of populations known", "has missing data")) + 
  labs(fill="Indicator 2 data") +
  xlab("")

```

By method to define pops
```{r}
ind2_data %>%
  ggplot(aes(x=defined_populations_simplified, fill=is.na(indicator2)))+
  geom_bar(position = "dodge") +
  coord_flip()+ 
  scale_fill_discrete(labels=c("number of populations known", "has missing data")) + 
  labs(fill="Indicator 2 data") +
  xlab("")
```
By method to define pops and country
```{r}
ind2_data %>%
  ggplot(aes(x=defined_populations_simplified, fill=is.na(indicator2)))+
  geom_bar(position = "dodge") +
  coord_flip()+ 
  scale_fill_discrete(labels=c("number of populations known", "has missing data")) + 
  labs(fill="Indicator 2 data") +
  xlab("") + facet_wrap(country_assessment ~., nrow = 2) +
  theme(panel.border = element_blank(), legend.position="bottom")
  
```

By taxonomic group and country
```{r}
ind2_data %>%
  ggplot(aes(x=taxonomic_group, fill=is.na(indicator2)))+
  geom_bar(position = "dodge") +
  coord_flip()+ 
  scale_fill_discrete(labels=c("number of populations known", "has missing data")) + 
  labs(fill="Indicator 2 data") +
  xlab("") + facet_wrap(country_assessment ~., nrow = 2) +
  theme(panel.border = element_blank(), legend.position="right")
  
```


### Distribution of multiassessments and single assesments
Some taxa were assessed more than once to account for, for example, different ways in how to delimit populations. Create a subset of them, excluding those records with missing data in indicator2 (due to missing data in n_pops). 

```{r}
#subset only with taxa assessed multiple times:
ind2_data_multi<-ind2_data %>% 
                          filter(multiassessment=="multiassessment") 
```

In total there are `r nrow(ind2_data_multi)` multiassessed records, of `r length(unique(ind2_data_multi$taxon))` taxa. Notice that this can include missing data in the number of populations, hence not allowing to estimate indicator 2.

To be able to visualize the missing data, the following plot changes NA to -1.
Variation in the number of extant populations by assessment

```{r, out.width=800, out.height=500}
# plot
ind2_data_multi %>% 
  mutate(n_extant_populations=ifelse(is.na(n_extant_populations), -1, n_extant_populations)) %>%
  ggplot(aes(x=taxon, y=n_extant_populations)) +
          geom_line(colour="darkgrey") + 
          geom_point(aes(color=country_assessment)) +
  xlab("") +
  coord_flip() +
  ggtitle("Variation in the number of extant populations, \nfor multiassessed taxa") +
  theme_bw() + 
  theme(legend.position = "bottom")
```

Same plot, but excluding Bombus terricola's massive variation:

```{r, out.width=800, out.height=500}
# plot
ind2_data_multi %>% 
  filter(taxon!="Bombus terricola") %>% 
  mutate(n_extant_populations=ifelse(is.na(n_extant_populations), -1, n_extant_populations)) %>%
  ggplot(aes(x=taxon, y=n_extant_populations)) +
          geom_line(colour="darkgrey") + 
          geom_point(aes(color=country_assessment)) +
  xlab("") +
  coord_flip() +
  ggtitle("Variation in the number of extant populations, \nfor multiassessed taxa") +
  theme_bw() + 
  theme(legend.position = "bottom")
```

Now for extinct populations (NA transformed as -1 for visualization purposes):

```{r, out.width=800, out.height=500}
# plot
ind2_data_multi %>% 
  mutate(n_extint_populations=ifelse(is.na(n_extint_populations), -1, n_extint_populations)) %>%
  ggplot(aes(x=taxon, y=n_extint_populations)) +
          geom_line(colour="darkgrey") + 
          geom_point(aes(color=country_assessment)) +
  xlab("") +
  coord_flip() +
  ggtitle("Variation in the number of extinct populations, \nfor multiassessed taxa") +
  theme_bw() + 
  theme(legend.position = "bottom")
```

See you later, Bombus terricola

```{r, out.width=800, out.height=500}
# plot
ind2_data_multi %>% 
  filter(taxon!="Bombus terricola") %>%
  mutate(n_extint_populations=ifelse(is.na(n_extint_populations), -1, n_extint_populations)) %>%
  ggplot(aes(x=taxon, y=n_extint_populations)) +
          geom_line(colour="darkgrey") + 
          geom_point(aes(color=country_assessment)) +
  xlab("") +
  coord_flip() +
  ggtitle("Variation in the number of extinct populations, \nfor multiassessed taxa") +
  theme_bw() + 
  theme(legend.position = "bottom")
```

This is how much the values of indicator2 vary within mutliassessed taxa (taxa names with no shown values mean they have missing data in the number of populations and hence indicator 2 can't be estimated):

```{r, out.width=800, out.height=500}

# plot
highlight8<- ind2_data_multi %>% 
  ggplot(aes(x=taxon, y=indicator2)) +
          geom_line(colour="darkgrey") + 
          geom_point(aes(color=country_assessment)) +
  xlab("") +
  coord_flip() +
  ggtitle("Variation in indicator 2, \nfor multiassessed taxa") +
  theme_bw() + 
  theme(legend.position = "bottom")

highlight8

```

For exploratory purposes, unless otherwise stated differently, the analyses below will use a subset of the data including only taxa assessed a single time, plus the first record of those assessed multiple times.

```{r}
#subset keeping only taxa assessed a single time, plust the first record of those assessed multiple times.
ind2_data_firstmulti<-ind2_data[!duplicated(cbind(ind2_data$taxon, ind2_data$country_assessment)), ]

```


### Indicator 2 values distribution

Remember, for exploratory purposes, unless otherwise stated differently, the analyses below will use a subset of the data including only taxa assessed a single time, plus the first record of those assessed multiple times.


For the taxa that do have data, this is how the values of indicator2 are distributed: 

```{r}
hist(ind2_data_firstmulti$indicator2)
```

Visualizing by country

```{r}
# get sample size by desired category

sample_size <- ind2_data_firstmulti %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(country_assessment) %>% summarize(num=n())

# plot
highlight9<-ind2_data_firstmulti %>% 
  # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(country_assessment, " (n= ", num, ")")) %>%

  # plot
  ggplot(aes(x=myaxis, y=indicator2, fill=country_assessment)) +
  geom_violin(width= 1, linewidth = 0)  +
  geom_jitter(size=.5, width = 0.1) +
  xlab("") +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none")
highlight9

```

Visualizing by taxonomic group:

```{r}
# get sample size by desired category

sample_size <- ind2_data_firstmulti %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(taxonomic_group) %>% summarize(num=n())

# plot
highlight10<-ind2_data_firstmulti %>% 
  # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(taxonomic_group, " (n= ", num, ")")) %>%
  
  #plot
ggplot(aes(x=myaxis, y=indicator2, fill=taxonomic_group), color=NA) +
      geom_violin(width=2, linewidth = 0)  +
      geom_jitter(size=.5, width = 0.1, color="brown") +
      xlab("") +
      coord_flip() +
      scale_fill_manual(values= taxoncolors,
                    breaks=c(levels(as.factor(ind2_data_firstmulti$taxonomic_group)))) +
      theme_bw() +
      theme(panel.border = element_blank(), legend.position="none", text = element_text(size = 15)) 
highlight10
      
```

Same boxplot
```{r}
# get sample size by desired category
sample_size <- ind2_data_firstmulti %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(taxonomic_group) %>% summarize(num=n())

ind2_data_firstmulti %>% 
  # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(taxonomic_group, " (n= ", num, ")")) %>%
  
  #plot
ggplot(aes(x=myaxis, y=indicator2, color=taxonomic_group)) +
      geom_boxplot()  +
      geom_jitter(size=.5, width = 0.1, color="brown") +
      xlab("") +
      coord_flip() +
      scale_color_manual(values= taxoncolors,
                    breaks=c(levels(as.factor(ind2_data_firstmulti$taxonomic_group)))) +
      theme_bw() +
      theme(panel.border = element_blank(), legend.position="none", text = element_text(size = 15)) 
```

Zoom in to invertebrates by country:

```{r}
ind2_data_firstmulti %>% 
      filter(!is.na(indicator2)) %>%
      filter(taxonomic_group=="invertebrate") %>% 

ggplot(aes(x=country_assessment, y=indicator2, fill=country_assessment), color=NA) +
      geom_violin()  +
      geom_jitter(size=.7, width = 0.1, color="black") +
      xlab("") +
      coord_flip() +
      theme_bw() +
      theme(panel.border = element_blank(), legend.position="none", text = element_text(size = 15)) +
      ggtitle("Distribution of Indicator 2 for Invertebrates")
```


Visualizing by IUCN:

```{r}

# add IUCN data form metadata to ind2
ind2_data_firstmulti$global_IUCN <- metadata_firstmulti$global_IUCN

# get sample size by desired category
sample_size <- ind2_data_firstmulti %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(global_IUCN) %>% summarize(num=n())

# plot
highlight11<-ind2_data_firstmulti %>% 
  # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(global_IUCN, " (n= ", num, ")")) %>%

  # plot
  ggplot(aes(x=myaxis, y=indicator2, fill=global_IUCN)) +
      geom_violin(width=1, linewidth = 0)  +
      geom_jitter(size=.5, width = 0.1) +
      xlab("") +
      coord_flip() +
      scale_fill_manual(values= IUCNcolors, # iucn color codes
                    breaks=c(levels(as.factor(ind2_data_firstmulti$global_IUCN)))) +
      theme_bw() +
      theme(panel.border = element_blank(), legend.position="none", text= element_text(size=15))
highlight11
      
```

Visualizing by range type:

```{r}

# add data form metadata to ind2
ind2_data_firstmulti$species_range <- metadata_firstmulti$species_range

# get sample size by desired category
sample_size <- ind2_data_firstmulti %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(species_range) %>% summarize(num=n())

# plot
ind2_data_firstmulti %>% 
  # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(species_range, " (n= ", num, ")")) %>%

  # plot
  ggplot(aes(x=myaxis, y=indicator2, fill=species_range)) +
      geom_violin(width=1, linewidth = 0)  +
      geom_jitter(size=.5, width = 0.1) +
      xlab("") +
      coord_flip() +
      theme_bw() +
      theme(panel.border = element_blank(), legend.position="none", text= element_text(size=20))

      
```

Visualizing by rarity:

```{r}

# add data form metadata to ind2
ind2_data_firstmulti$rarity <- metadata_firstmulti$rarity

# get sample size by desired category
sample_size <- ind2_data_firstmulti %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(rarity) %>% summarize(num=n())

# plot
ind2_data_firstmulti %>% 
  # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(rarity, " (n= ", num, ")")) %>%

  # plot
  ggplot(aes(x=myaxis, y=indicator2, fill=rarity)) +
      geom_violin(width=1, linewidth = 0)  +
      geom_jitter(size=.5, width = 0.1) +
      xlab("") +
      coord_flip() +
      theme_bw() +
      theme(panel.border = element_blank(), legend.position="none", text= element_text(size=20))
```

By population method 

```{r}
# get sample size by desired category

sample_size <- ind2_data_firstmulti %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(defined_populations_simplified) %>% summarize(num=n())

# plot
highlight12<-ind2_data_firstmulti %>% 
  # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(defined_populations_simplified, " (n= ", num, ")")) %>%

  # plot
  ggplot(aes(x=myaxis, y=indicator2, fill=defined_populations_simplified)) +
  geom_violin(width= 1, linewidth = 0)  +
  geom_jitter(size=.5, width = 0.1) +
  xlab("") +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") +
  scale_fill_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data_firstmulti$defined_populations_simplified)))
highlight12

```


Same, boxplot version:


```{r}
# get sample size by desired category

sample_size <- ind2_data_firstmulti %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(defined_populations_simplified) %>% summarize(num=n())

# plot
highlight13<-ind2_data_firstmulti %>% 
  # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(defined_populations_simplified, " (n= ", num, ")")) %>%

  # plot
  ggplot(aes(x=myaxis, y=indicator2, color=defined_populations_simplified)) +
  geom_boxplot()  +
  geom_jitter(size=.5, width = 0.1, color="black") +
  xlab("") +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") +
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified)))
highlight13
```

Facet by country
```{r, out.width="1000px", out.height="700px"}
highlight14<-ind2_data_firstmulti %>% 

  # plot
  ggplot(aes(x=defined_populations_simplified, y=indicator2, color=defined_populations_simplified)) +
  geom_boxplot()  +
  geom_jitter(size=.5, width = 0.1, color="black") +
  xlab("") +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") + 
  facet_wrap(~country_assessment, ncol=3) +
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data_firstmulti$defined_populations_simplified)))

highlight14
```

Facet by country and IUCN
```{r, out.width="1000px", out.height="700px"}
ind2_data_firstmulti %>% 

  # plot
 ggplot(aes(x=global_IUCN, y=indicator2, fill=global_IUCN)) +
      geom_violin(width=1, linewidth = 0)  +
      geom_jitter(size=.5, width = 0.1) +
      xlab("") +
      coord_flip() +
      scale_fill_manual(values= IUCNcolors, # iucn color codes
                    breaks=c(levels(as.factor(ind2_data_firstmulti$global_IUCN)))) +
      theme_bw() +
      theme(panel.border = element_blank(), legend.position="none", text= element_text(size=15)) + 
  facet_wrap(~country_assessment, ncol=3) +
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data_firstmulti$defined_populations_simplified)))


```


### Indicator 2 within single countries

Value of indicator 2 within a single country, by method to define populations, taxonomic group and iucn. Including only 1 assessment per multiassessed taxa.

```{r, out.width="600px", out.height="800px"}

### For loop, 3 plots (defined_populations_simplified, taxonomic and global IUCN) by country.
for(i in unique(ind2_data_firstmulti$country_assessment)){


  # filter to desired country in the loop
x <-ind2_data_firstmulti %>% filter(country_assessment==i)


### for pops method

# build plot
p1<- x %>% 
  ggplot(aes(x=defined_populations_simplified, y=indicator2, color=defined_populations_simplified)) +
  geom_boxplot()  +
  geom_jitter(size=.5, width = 0.1, color="black") +
  coord_flip() +
  xlab("") +
  
    ## manually set color
  # use ind2_data_firstmulti instead of x to define number of colors and breaks
  # to ensure same colors are used in all countries
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data_firstmulti$defined_populations_simplified))) +
  
  #theme options
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") +
  # the plot at the top should have title and no x axis text and labels
  theme(axis.text.x = element_blank()) +
  ylab("") +
  ggtitle(i)

### for taxonomic group
# build plot
p2<- x %>% 
  ggplot(aes(x=taxonomic_group, y=indicator2, color=taxonomic_group)) +
  geom_boxplot()  +
  geom_jitter(size=.5, width = 0.1, color="black") +
  coord_flip() +
  xlab("") +
  
  
  ## manually set color
  # use ind2_data_firstmulti instead of x to define number of colors and breaks
  # to ensure same colors are used in all countries
  scale_color_manual(values=taxoncolors,
                     breaks=levels(as.factor(ind2_data_firstmulti$taxonomic_group))) +
                                       
  # theme options
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none") +
  # the plot at the middle should have no x axis text and labels and no title
  theme(axis.text.x = element_blank()) +
  ylab("")

### for global IUCN
# build plot
p3<- x %>% 
  ggplot(aes(x=global_IUCN, y=indicator2, color=global_IUCN)) +
  geom_boxplot()  +
  geom_jitter(size=.5, width = 0.1, color="black") +
  coord_flip() +
  xlab("") +
  
  ## manually set color
  # use ind2_data_firstmulti instead of x to define number of colors and breaks
  # to ensure same colors are used in all countries
  scale_color_manual(values=IUCNcolors, # iucn color codes,
                     breaks=levels(as.factor(ind2_data_firstmulti$global_IUCN))) +
                                       
  # theme options
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none")
  # the plot at the bottom should have axis and labels

#### the 3 plots togheter
# plot_grid from cowplot helps to keep the ploting area aligned.
print(plot_grid(p1, p2, p3, ncol = 1, align = 'v'))
}


```



### Does the number of populations affects the value of indicator 2? (excluding outliers: >200 pops) and incluidng all records of multiassessed taxa:

```{r}
ind2_data %>%
  # filter outliers with too many pops
  filter(n_extant_populations<200) %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=indicator2)) +
    geom_point()

```

Same, colouring by country


```{r}
ind2_data %>%
  # filter outliers with too many pops
  filter(n_extant_populations<200) %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=indicator2, color=country_assessment)) +
    geom_point() +
    theme_bw()

```

By global IUCN risk

```{r}
ind2_data$global_IUCN<-metadata$global_IUCN

ind2_data %>%
  # filter outliers with too many pops
  filter(n_extant_populations<200) %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=indicator2, color=global_IUCN)) +
    geom_point() + 
        scale_color_manual(values= IUCNcolors, # iucn color codes
                           breaks=c(levels(as.factor(ind2_data$global_IUCN)))) +
  theme_bw()


```

By population definition method:

```{r}
ind2_data %>%
  # filter outliers with too many pops
  filter(n_extant_populations<200) %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=indicator2, color=defined_populations_simplified)) +
    geom_point() +
    theme_bw() +
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified)))

```
Run model (first removing missing data)
```{r}
# remove missing data 
ind2_data_wo_missing<-ind2_data %>% 
                      filter(!is.na(indicator2)) %>%
                      filter(n_extant_populations<500) # doesn't make a difference in the test below, but useful for plots

# check n per method
table(ind2_data_wo_missing$defined_populations_simplified)

# run model
m2 <- glm(ind2_data_wo_missing$indicator2 ~ ind2_data_wo_missing$n_extant_populations + 
            ind2_data_wo_missing$defined_populations_simplified + 
            ind2_data_wo_missing$n_extant_populations*ind2_data_wo_missing$defined_populations_simplified, family = "quasibinomial")
m2
summary(m2)

```


Put side by side the plots of number of populations and indicator 2 range (excluding >200 pops outlieres):
```{r, out.height="500px", out.width="1064px"}
## plot for number of populations

# sample size of TOTAL populations
sample_size <- ind2_data %>%
                    filter(!is.na(indicator2)) %>% 
                    group_by(defined_populations_simplified) %>% summarize(num=n())

p1<-ind2_data %>% 
  filter(n_extant_populations<500) %>%
    # add sampling size 
  left_join(sample_size) %>%
  mutate(myaxis = paste0(defined_populations_simplified, " (n= ", num, ")")) %>%
  
# plot
  ggplot(aes(x=myaxis, y=n_extant_populations, color=defined_populations_simplified)) +
          geom_boxplot() + xlab("") + ylab("Number of extant populations") +
          geom_jitter(size=.4, width = 0.1, color="black") +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none",
        plot.margin = unit(c(0, 0, 0, 0), "cm")) + # this is used to decrease the space between plots
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified))) +
    theme(text = element_text(size = 15))

## plot for indicator 2
p2<-ind2_data %>% 
  filter(n_extant_populations<500) %>%
  ggplot(aes(x=defined_populations_simplified, y=indicator2, color=defined_populations_simplified)) +
          geom_boxplot() + xlab("") + ylab("Indicator 2") +
          geom_jitter(size=.4, width = 0.1, color="black") +
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(), legend.position="none", axis.text.y = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "cm")) + # this is used to decrease the space between plots) + 
  scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified))) +
  theme(text = element_text(size = 15))

plot_grid(p1, p2, ncol=2, rel_widths = c(1.5,1))
```
Add the scatter plot of indicator2 and extant pops as a third pannel
```{r}
p3<- ind2_data %>%
  # filter outliers with too many pops
  filter(n_extant_populations<500) %>%
  
  # plot
    ggplot(aes(x=n_extant_populations, y=indicator2, color=defined_populations_simplified)) +
    geom_point() +
    theme_bw() +
    scale_color_manual(values=simplifiedmethods_colors,
                    breaks=levels(as.factor(ind2_data$defined_populations_simplified))) +
    theme(legend.position = "none") +
    ylab("Indicator 2") +
    xlab("Number of extant populations") +
    theme(text = element_text(size = 15))
p3

plot_grid(p1, p2, p3, ncol=3, rel_widths = c(1.7,1,1), align = "h")  

```

### ANOVAS on the number of extant populations

One-way ANOVA for the effect of the **method to define populations** on indicator 2, removing the extreme outlier (>1,000 pops)

```{r, echo=TRUE, message=TRUE}
# subset data without massive outlier
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<1000)

# summary of n per variable
table(ind2_data_anova$defined_populations_simplified)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ defined_populations_simplified, data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Same One-way ANOVA for the effect of the **method to define populations** on indicator 2, but removing outliers >200 pops

```{r, echo=TRUE, message=TRUE}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<200)

# summary of n per variable
table(ind2_data_anova$defined_populations_simplified)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ defined_populations_simplified, data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
  ```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


One-way ANOVA for the effect of the **country** on indicator 2, removing outliers >200 pops

```{r, echo=TRUE, message=TRUE}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<200)

# summary of n per variable
table(ind2_data_anova$country_assessment)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ country_assessment, data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
  ```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


One-way ANOVA for the effect of the **taxonomic group** on indicator 2, removing outliers >200 pops and taxonomic groups with too few data

```{r, echo=TRUE, message=TRUE}
# summary of n per variable
table(ind2_data$taxonomic_group)

# subset data 
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<200) %>% 
  filter(taxonomic_group %!in% c("fungus", "bryophyte", "other", "pteridophytes"))

# summary of n per variable
table(ind2_data_anova$taxonomic_group)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ taxonomic_group, data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
  ```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```

Two-way ANOVA with interaction effect of the method to define populations and the country, removing outliers >200 pops
**Question: is interaction he correct model? or should it be additive?**
  
  ```{r}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<200)

# summary of n per variable
ind2_data_anova %>%
  group_by(country_assessment, defined_populations_simplified) %>% summarise(n=n())

# Two-way ANOVA with interaction effect of the method to define populations and the country
res.anova.extant<-aov(indicator2 ~ defined_populations_simplified * country_assessment , data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)

```
Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
  ```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


Two-way ANOVA with interaction effect of the method to define populations and the country, but keeping only groups with enough n
```{r, echo=TRUE, message=TRUE}
# variables with enough n
enough_n<-ind2_data %>%
  group_by(country_assessment, defined_populations_simplified) %>% 
  summarise(n=n()) %>% 
  filter(n>=15)


# subset data without outliers and with enough n
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<200) %>% 
  # this gives the country
  filter(country_assessment==unique(enough_n$country_assessment)[1] & 
           #this gives the methods for that country (the last [[1]] is to get the results out of a list)
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[1], 2][[1]]  | 
           
           # the same for rest of countries. Notice the use of & for methods within country and | to change to other country
           country_assessment==unique(enough_n$country_assessment)[2] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[2], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[3] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[3], 2][[1]] |
           
           country_assessment==unique(enough_n$country_assessment)[4] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[4], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[5] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[5], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[6] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[6], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[7] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[7], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[8] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[8], 2][[1]])

# summary of n per variable
ind2_data_anova %>%
  group_by(country_assessment, defined_populations_simplified) %>% summarise(n=n())

# Two-way ANOVA with interaction effect of the method to define populations and the country
res.anova.extant<-aov(indicator2 ~ defined_populations_simplified * country_assessment , data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```
Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
  ```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```

### ANOVAs on indicator 2

One-way ANOVA for the effect of the **method to define populations** on indicator 2, removing the extreme outlier (>1,000 pops)

```{r, echo=TRUE, message=TRUE}
# subset data without massive outlier
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<1000)

# summary of n per variable
table(ind2_data_anova$defined_populations_simplified)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ defined_populations_simplified, data=ind2_data_anova)
summary(res.anova.extant)
```

Same One-way ANOVA for the effect of the **method to define populations** on indicator 2, but removing outliers >1000 pops

```{r, echo=TRUE, message=TRUE}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<1000)

# summary of n per variable
table(ind2_data_anova$defined_populations_simplified)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ defined_populations_simplified, data=ind2_data_anova)
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```

One-way ANOVA for the effect of the **country** on indicator 2, removing outliers >1000 pops

```{r, echo=TRUE, message=TRUE}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<1000)

# summary of n per variable
table(ind2_data_anova$country_assessment)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ country_assessment, data=ind2_data_anova)
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


One-way ANOVA for the effect of the **taxonomic group** on indicator 2, removing outliers >1000 pops and taxonomic groups with too few data

```{r, echo=TRUE, message=TRUE}
# summary of n per variable
table(ind2_data$taxonomic_group)

# subset data 
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<1000) %>% 
  filter(taxonomic_group %!in% c("fungus", "bryophyte", "other"))

# summary of n per variable
table(ind2_data_anova$taxonomic_group)

# One way ANOVA
res.anova.extant<-aov(indicator2 ~ taxonomic_group, data=ind2_data_anova)
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```
One-way ANOVA for the effect of the **global IUCN** on indicator 2, removing outliers >1000 pops and taxonomic groups with too few data

```{r, echo=TRUE, message=TRUE}
# summary of n per variable
table(ind2_data$global_IUCN)

# subset data 
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<1000) %>% 
  filter(global_IUCN %!in% c("dd", "unknown"))

# summary of n per variable
table(ind2_data_anova$global_IUCN)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ global_IUCN, data=ind2_data_anova)
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):
```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```

One-way ANOVA for the effect of the **species range** on indicator 2

```{r, echo=TRUE, message=TRUE}
# summary of n per variable
table(ind2_data$species_range)

# subset data 
ind2_data_anova<- ind2_data %>% 
                  filter(species_range != "unknown")

# summary of n per variable
table(ind2_data_anova$species_range)

# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ species_range, data=ind2_data_anova)
summary(res.anova.extant)
```

One-way ANOVA for the effect of the **rarity** on indicator 2

```{r, echo=TRUE, message=TRUE}
# summary of n per variable

table(ind2_data_firstmulti$rarity)

# subset data 
ind2_data_anova<- ind2_data_firstmulti


# One way ANOVA method
res.anova.extant<-aov(indicator2 ~ species_range, data=ind2_data_anova)
summary(res.anova.extant)
```


Two-way ANOVA with interaction effect of the method to define populations and the country, removing outliers >200 pops
**Question: is interaction he correct model? or should it be additive?**
  
```{r}
# subset data without outliers
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<200)

# summary of n per variable
ind2_data_anova %>%
  group_by(country_assessment, defined_populations_simplified) %>% summarise(n=n())

# Two-way ANOVA with interaction effect of the method to define populations and the country
res.anova.extant<-aov(indicator2 ~ defined_populations_simplified * country_assessment , data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)

```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):

```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```


Two-way ANOVA with interaction effect of the method to define populations and the country, but keeping only groups with enough n

```{r, echo=TRUE, message=TRUE}
# variables with enough n
enough_n<-ind2_data %>%
  group_by(country_assessment, defined_populations_simplified) %>% 
  summarise(n=n()) %>% 
  filter(n>=15)


# subset data without outliers and with enough n
ind2_data_anova<- ind2_data %>% 
  filter(indicator2<200) %>% 
  # this gives the country
  filter(country_assessment==unique(enough_n$country_assessment)[1] & 
           #this gives the methods for that country (the last [[1]] is to get the results out of a list)
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[1], 2][[1]]  | 
           
           # the same for rest of countries. Notice the use of & for methods within country and | to change to other country
           country_assessment==unique(enough_n$country_assessment)[2] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[2], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[3] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[3], 2][[1]] |
           
           country_assessment==unique(enough_n$country_assessment)[4] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[4], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[5] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[5], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[6] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[6], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[7] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[7], 2][[1]] | 
           
           country_assessment==unique(enough_n$country_assessment)[8] & 
           defined_populations_simplified %in% enough_n[enough_n$country_assessment==unique(enough_n$country_assessment)[8], 2][[1]])

# summary of n per variable
ind2_data_anova %>%
  group_by(country_assessment, defined_populations_simplified) %>% summarise(n=n())

# Two-way ANOVA with interaction effect of the method to define populations and the country
res.anova.extant<-aov(indicator2 ~ defined_populations_simplified * country_assessment , data=ind2_data_anova)
res.anova.extant
summary(res.anova.extant)
```

Since there significant differences, check which pairs are actually different (Tukey Honest Significant Differences):

```{r}
# only padj < 0.05
x<-TukeyHSD(res.anova.extant)
x<-as.data.frame(x[[1]])
x[x$`p adj`<0.05, ]
```



## Estimate indicator 3 (number of taxa with genetic monitoring squemes)

Indicator 3 refers to the number (count) of taxa by country in which genetic monitoring is occurring. This is stored in the variable `temp_gen_monitoring` as a "yes/no" answer for each taxon, so to estimate the indicator, we only need to count how many said "yes", keeping only one of the records when the taxon was multiassessed:

```{r}
indicator3<-ind3_data %>%
                 # keep only one record if the taxon was assessed more than once within the country
                 select(country_assessment, taxon, temp_gen_monitoring) %>%
                 filter(!duplicated(.)) %>%

                 # count "yes" in tem_gen_monitoring by country
                 filter(temp_gen_monitoring=="yes") %>%
                 group_by(country_assessment) %>%
                 summarise(n_taxon_gen_monitoring= n())
```

Plot indicator 3 by country:

```{r}
## from the table counting studies by country
indicator3 %>%
  ggplot(aes(x=country_assessment, y=n_taxon_gen_monitoring)) +
  geom_bar(stat="identity")



## from raw data to include other variables for color by taxonomic group
highlight6<-ind3_data %>%
                 # keep only one record if the taxon was assessed more than once within the country
                 select(country_assessment, taxon, temp_gen_monitoring, taxonomic_group) %>%
                 filter(!duplicated(.)) %>%

                 # count "yes" in tem_gen_monitoring by country
                 filter(temp_gen_monitoring=="yes") %>%
ggplot(aes(x=country_assessment, fill=taxonomic_group)) +
  geom_bar() +
  scale_fill_manual(values= taxoncolors,
                    breaks=levels(as.factor(ind3_data$taxonomic_group))) +
  theme_bw()

highlight6

## by iucn

ind3_data$global_IUCN<-metadata$global_IUCN

highlight6.1<-ind3_data %>%
                 # keep only one record if the taxon was assessed more than once within the country
                 select(country_assessment, taxon, temp_gen_monitoring, global_IUCN) %>%
                 filter(!duplicated(.)) %>%

                 # count "yes" in tem_gen_monitoring by country
                 filter(temp_gen_monitoring=="yes") %>%
ggplot(aes(x=country_assessment, fill=global_IUCN)) +
  geom_bar() +
  scale_fill_manual(values= IUCNcolors, # iucn color codes
                    breaks=levels(as.factor(ind3_data$global_IUCN))) +
      theme_bw()

highlight6.1

```

Relatively few taxa have genetic monitoring, but many have some sort of genetic study. Let's check that, but first subset the ind3_data keeping only taxa assessed a single time, plust the first record of those assessed multiple times.
```{r}
#subset keeping only taxa assessed a single time, plust the first record of those assessed multiple times.
ind3_data_firstmulti<-ind3_data[!duplicated(cbind(ind3_data$taxon, ind3_data$country_assessment)), ]
```

Sankey plot of genetic studies

```{r}
# transform data to how ggsankey wants it
df <- ind3_data_firstmulti %>%
  make_long(country_assessment, temp_gen_monitoring, gen_studies)

# plot
ggplot(df, aes(x = x,
               next_x = next_x,
               node = node,
               next_node = next_node,
               fill = factor(node),
               label = node)) +
  geom_sankey(flow.alpha = 0.5, 
              show.legend = FALSE) +
  geom_sankey_label(size = 2.5, color = "black", fill = "white") +
  theme_sankey(base_size = 10) +

    # manually set flow fill according to desired color
                            # countries
  scale_fill_manual(values=c(scales::hue_pal()(length(unique(ind3_data_firstmulti$country_assessment))),  
                             # traffic light for monitoring
                             c("darkolivegreen", "brown3", "darkgrey"),
                             # nice soft colors for gen_studies
                             c("grey50", "grey35", "grey50", "brown3")),
                              
                    breaks=c(unique(ind3_data_firstmulti$country_assessment),
                             unique(ind3_data_firstmulti$temp_gen_monitoring),
                             unique(ind3_data_firstmulti$gen_studies))) +
  
  xlab("")


```

Similar, but alluvial to show data colloring the flow by country
```{r}
# format data as needed
foralluvial_2<-ind3_data_firstmulti %>% group_by(country_assessment, temp_gen_monitoring, gen_studies) %>%
             summarise(n=n())

# define colors
my_cols<- gg_color_hue(length(unique(foralluvial_2$country_assessment)))
# we need a vector of colors by country for each row of the dataset, so:
countries<-as.factor(foralluvial_2$country_assessment)
levels(countries)<-my_cols
countries<-as.vector(countries)

# plot (highlight7)
alluvial(foralluvial_2[,1:3], freq = foralluvial_2$n,
         col=countries,  
         blocks=FALSE,
         gap.width = 0.5,
         cex=.8, 
         xw = 0.1,
         cw = 0.2,
         border = NA)


```

# Highlights 

### Taxa and records by country

```{r}
highlight1
highlight2
highlight3

# highlight4
foralluvial_1<-metadata_firstmulti %>% group_by(country_assessment, taxonomic_group, popsize_data) %>%
             summarise(n=n())
head(foralluvial_1)

## plot
# define colors
my_cols<- gg_color_hue(length(unique(foralluvial_1$country_assessment)))

# we need a vector of colors by country for each row of the dataset, so:
countries<-as.factor(foralluvial_1$country_assessment)
levels(countries)<-my_cols
countries<-as.vector(countries)
head(countries)

# plot
alluvial(foralluvial_1[,1:3], freq = foralluvial_1$n,
         col=countries, 
         blocks=FALSE,
         gap.width = 0.5,
         cex=.8, 
         xw = 0.1,
         cw = 0.2,
         border = NA)


highlight5

```

### Indicator 3

```{r}
highlight6

# highlight7
# format data as needed
foralluvial_2<-ind3_data_firstmulti %>% group_by(country_assessment, temp_gen_monitoring, gen_studies) %>%
             summarise(n=n())

# define colors
my_cols<- gg_color_hue(length(unique(foralluvial_2$country_assessment)))
# we need a vector of colors by country for each row of the dataset, so:
countries<-as.factor(foralluvial_2$country_assessment)
levels(countries)<-my_cols
countries<-as.vector(countries)

# plot (highlight7)
alluvial(foralluvial_2[,1:3], freq = foralluvial_2$n,
         col=countries,  
         blocks=FALSE,
         gap.width = 0.5,
         cex=.8, 
         xw = 0.1,
         cw = 0.2,
         border = NA)

```


### Indicator 2

```{r}
highlight8
highlight9
highlight10
highlight11
highlight12
```


Plots by country, see forloop above.

## Session Info for reproducibility purposes:

```{r}
sessionInfo()
```

