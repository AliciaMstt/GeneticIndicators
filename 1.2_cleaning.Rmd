---
title: "Data exploration and cleaning"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

This notebook corrects the errors detected by [1.1_quality_check.Rmd](1.1_quality_check.Rmd), based on the feed back from the people who collected the data. Corrections are done within this script to ensure reproducibility.

The output is a clean kobo file that can be used for analyses.

## Get data, libraries and functions

Load required libraries:

```{r, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
library(utile.tools)
library(stringr)
library(ggplot2)
library(readr)
```

Useful custom functions
```{r}
source("get_attached_files.R")
source("process_attached_files.R")

# not in
"%!in%" <- function(x, y)!('%in%'(x,y))
```


Get Kobo raw output data:
```{r}
kobo_output<-read.csv(file="International_Genetic_Indicator_testing_V_4.0_-_latest_version_-_False_-_2023-08-23-07-19-11.csv", sep=";", header=TRUE) %>%

## add  taxon column
mutate(taxon=(utile.tools::paste(genus, species, subspecies_variety, na.rm=TRUE))) %>%
    # remove white space at the end of the name
    mutate(taxon=str_trim(taxon, "right"))

```


## Filter tests and records marked as not approved

Filter out records which were marked as "not_approved" in the manual Kobo validation interface (this means country assessors determined the is something wrong with that particular record).

```{r}
# check if any species is flagged as "validation_status_not_approved"
kobo_output %>%
      filter(X_validation_status=="validation_status_not_approved")

# omit those records from data:
kobo_clean<- kobo_output %>%
            filter(X_validation_status!="validation_status_not_approved")

```

Filter out any sort of tests

```{r}
# select likely columns to say "test"
cols= c("name_assessor", "email_assessor", "genus", "species", "subspecies_variety",
         "scientific_authority", "common_name", "GBIF_taxonID", "NCBI_taxonID", "time_populations")

# check for "test" on any of them
kobo_clean %>% 
  filter(if_any(all_of(cols), ~ grepl("test", .)))  %>% 
  select(country_assessment, name_assessor, genus, species, X_uuid)

# filter them out of dataset
kobo_clean<- kobo_clean %>% 
              filter(if_any(all_of(cols), ~ !grepl("test", .)))  %>%
              filter(species != "test")

```

## Number of populations


### Change -999 to NA
In the form, -999 was used to mark taxa with unknown number of extant populations. This was used because answering the question was mandatory, so leaving it blank wasn't possible. We have to change -999 to NA.

For n extant populations:

```{r}
kobo_clean<- kobo_clean %>%
             mutate(n_extant_populations= na_if(n_extant_populations, -999))
```

For n extinct populations:

```{r}
kobo_clean<- kobo_clean %>%
             mutate(n_extint_populations= na_if(n_extint_populations, -999))
```


### Correct "negative populations"
Once -999 was replaced by NA there should be no negative number of populations (if they are, they are typos that need to be corrected).

Check for extant populations:

```{r}
kobo_clean %>%
      filter(n_extant_populations<0) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations)
```

Check for extinct populations:

```{r}
kobo_clean %>%
      filter(n_extint_populations<0) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations)
```

### Correct 999 populations

Show which species (if any) have 999 EXTINCT populations. **Should this be -999?**

Check for extinct populations:
```{r}
kobo_clean %>%
      filter(n_extint_populations==999) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, end)
```

Check for extant populations:
```{r}
kobo_clean %>%
      filter(n_extant_populations==999) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, end)
```

### Double check 0 (zero) extant populations

Show which taxa (if any) have 0 (zero) extant populations. **Is this correct? needs to be manually checked**
```{r}
kobo_clean %>%
      filter(n_extant_populations==0) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, end)

```

According to the assessors feedback the data of the following taxa is correct. For example, there are 0 extant populations because it is regionally extinct or because it was imposible to estimate how many populations it has:

```{r}
ok_0_extant<-c("Hieracium sandozianum",
               "Charadrius alexandrinus",
               "Planorbella magnifica",
               "Heterelmis stephani")
```

Filtering out those taxa that are correct we should have an empty object, is not, the remaining taxa still need to be verified:

```{r}
kobo_clean %>%
      filter(n_extant_populations==0) %>%
      filter(taxon %!in% ok_0_extant) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, end)

```


### Create an object with all "n pops" issues together

If there are any remaining taxa with weird number of populations put them together in a single object.

If everything is correct now, the object should be empity.

```{r}
check_n_pops <- kobo_clean %>% 
      # variables of interest
      select(country_assessment, name_assessor, taxon, n_extant_populations, n_extint_populations, end) %>%

      # same filters that discussed above
      filter(n_extant_populations<0 |
            n_extant_populations==0 | 
            n_extant_populations==999 | 
            n_extint_populations==999) %>%
      filter(taxon %!in% ok_0_extant) %>%

# add a column stating what needs to be checked:

       mutate(need_to_check="check number of extant or extint populations. Are 0 correct? should 999 be -999? are extant/extint confused?")
check_n_pops
```


## Correct GBIF ids

The quality check script flagged any records where the GBIF Id is =/= 7, because that is the most common length. Changes after the assessors checked their data:

Corrections requested:

```{r}
# Gymnobelideus leadbeateri 

kobo_clean[kobo_clean$taxon=="Gymnobelideus leadbeateri", "GBIF_taxonID"] 
kobo_clean[kobo_clean$taxon=="Gymnobelideus leadbeateri", "GBIF_taxonID"] <-2440054
kobo_clean[kobo_clean$taxon=="Gymnobelideus leadbeateri", "GBIF_taxonID"]  

# Zingel asper
kobo_clean[kobo_clean$taxon=="Zingel asper", "GBIF_taxonID"]  
kobo_clean[kobo_clean$taxon=="Zingel asper", "GBIF_taxonID"]  <- 2382117
kobo_clean[kobo_clean$taxon=="Zingel asper", "GBIF_taxonID"]  

# Miniopterus schreibersii
kobo_clean[kobo_clean$taxon=="Miniopterus schreibersii", "GBIF_taxonID"]  
kobo_clean[kobo_clean$taxon=="Miniopterus schreibersii", "GBIF_taxonID"]  <- 9796816
kobo_clean[kobo_clean$taxon=="Miniopterus schreibersii", "GBIF_taxonID"]  

# Toxolasma lividum
kobo_clean[kobo_clean$taxon=="Toxolasma lividum", "GBIF_taxonID"]  
kobo_clean[kobo_clean$taxon=="Toxolasma lividum", "GBIF_taxonID"]  <-157572593
kobo_clean[kobo_clean$taxon=="Toxolasma lividum", "GBIF_taxonID"]  

# Caladenia woolcockiorum
kobo_clean[kobo_clean$taxon=="Caladenia woolcockiorum", "GBIF_taxonID"]
kobo_clean[kobo_clean$taxon=="Caladenia woolcockiorum", "GBIF_taxonID"] <- 2841407
kobo_clean[kobo_clean$taxon=="Caladenia woolcockiorum", "GBIF_taxonID"]

# Phyllurus kabikabi
kobo_clean[kobo_clean$taxon=="Phyllurus kabikabi", "GBIF_taxonID"]
kobo_clean[kobo_clean$taxon=="Phyllurus kabikabi", "GBIF_taxonID"] <- 5843345
kobo_clean[kobo_clean$taxon=="Phyllurus kabikabi", "GBIF_taxonID"]

# Ambuchanania leuchbryoides
kobo_clean[kobo_clean$taxon=="Ambuchanania leuchbryoides", "GBIF_taxonID"]
kobo_clean[kobo_clean$taxon=="Ambuchanania leuchbryoides", "GBIF_taxonID"] <- 5792195
kobo_clean[kobo_clean$taxon=="Ambuchanania leuchbryoides", "GBIF_taxonID"]


# Phonotimpus talquian
kobo_clean[kobo_clean$taxon=="Phonotimpus talquian", "GBIF_taxonID"]
kobo_clean[kobo_clean$taxon=="Phonotimpus talquian", "GBIF_taxonID"] <- 9720487
kobo_clean[kobo_clean$taxon=="Phonotimpus talquian", "GBIF_taxonID"]

# Ecklonia radiata brevipes
kobo_clean[kobo_clean$taxon=="Ecklonia radiata brevipes", "GBIF_taxonID"]
kobo_clean[kobo_clean$taxon=="Ecklonia radiata brevipes", "GBIF_taxonID"] <- 3196095
kobo_clean[kobo_clean$taxon=="Ecklonia radiata brevipes", "GBIF_taxonID"]



```

Correct GBIF ids even if they look weird:

```{r}
ok_GBIF<-c("Caladenia woolcockiorum",
          "Leucopatus anophthalmus", 
          "Phyllurus kabikabi",
          "Phonotimpus talquian, Hypotaenidia sylvestris",
          "Chersobius signatus",
          "Hypotaenidia sylvestris",
          "Megascops gilesi",
          "Dubusia carrikeri")

## add the manually corrected too, in case they are != 7

ok_GBIF<-c(ok_GBIF,
           "Gymnobelideus leadbeateri",
           "Zingel asper",
           "Miniopterus schreibersii",
           "Toxolasma lividum",
           "Caladenia woolcockiorum",
           "Phyllurus kabikabi",
           "Ambuchanania leuchbryoides",
           "Phonotimpus talquian",
           "Anaxyrus williamsi")

```


### and object with all GBIF issues together

If there are any remaining taxa with weird GBIF ids put them together in a single object.

```{r}
check_GBIF <- kobo_clean %>%
              filter(nchar(GBIF_taxonID)>0, nchar(GBIF_taxonID)!=7) %>%
              filter(taxon %!in% ok_GBIF) %>%
  # show only relevant columns
            select(country_assessment, name_assessor, taxon, GBIF_taxonID, end) %>%
# add a column stating what needs to be checked:

       mutate(need_to_check="check the GBIF taxonID. Either it looks plain different, or has more or less than 7 digits (most ids are 7 digits long, and this isn't, it could be an exception, or a mistake).")
check_GBIF
```

## Taxon names

Genus, species and subspecies should be a single word, check if there are cases where it isn't. Only exception would be "var." or "subsp." in the subspecies_variety field: 

```{r}
kobo_clean %>% 
  filter(grepl(" ", genus) | 
         grepl(" ", species) | 
         grepl(" ", subspecies_variety)) %>%
   filter(!grepl("var.", subspecies_variety)) %>%
   filter(!grepl("subsp.", subspecies_variety)) %>%
  # show only relevant columns
  # show only relevant columns
            select(country_assessment, name_assessor, taxon, genus, species, subspecies_variety, end)

```


Corrections requested:

```{r}
# Gypaetus Gypaetus barbatus
kobo_clean[kobo_clean$taxon=="Gypaetus Gypaetus barbatus", "species"]
kobo_clean[kobo_clean$taxon=="Gypaetus Gypaetus barbatus", "species"] <-"barbatus"
kobo_clean[kobo_clean$taxon=="Gypaetus Gypaetus barbatus", "taxon"] <-"Gypaetus barbatus"
kobo_clean[kobo_clean$taxon=="Gypaetus barbatus", c("species", "taxon")] 

# Gyps Gyps coprotheres
kobo_clean[kobo_clean$taxon=="Gyps Gyps coprotheres", "species"]
kobo_clean[kobo_clean$taxon=="Gyps Gyps coprotheres", "species"] <-"coprotheres"
kobo_clean[kobo_clean$taxon=="Gypaetus Gypaetus barbatus", "taxon"] <-"Gypaetus barbatus"
kobo_clean[kobo_clean$taxon=="Gypaetus barbatus", c("species", "taxon")] 


# Hippocampus Hippocampus capensis
kobo_clean[kobo_clean$taxon=="Hippocampus Hippocampus capensis", "species"]
kobo_clean[kobo_clean$taxon=="Hippocampus Hippocampus capensis", "species"] <-"capensis"
kobo_clean[kobo_clean$taxon=="Hippocampus Hippocampus capensis", "taxon"] <-"Hippocampus capensis"
kobo_clean[kobo_clean$taxon=="Hippocampus capensis", c("species", "taxon")] 


# Poicephalus Poicephalus robustus
kobo_clean[kobo_clean$taxon=="Poicephalus Poicephalus robustus", "species"]
kobo_clean[kobo_clean$taxon=="Poicephalus Poicephalus robustus", "species"] <-"robustus"
kobo_clean[kobo_clean$taxon=="Poicephalus Poicephalus robustus", "taxon"] <-"Poicephalus robustus"
kobo_clean[kobo_clean$taxon=="Poicephalus robustus", c("species", "taxon")] 

# Campylorhynchus rufinucha humilis, rufinucha, nigricaudatus, xerophilus, nicaraguae, castaneus, capistratus
kobo_clean[kobo_clean$taxon=="Campylorhynchus rufinucha humilis, rufinucha, nigricaudatus, xerophilus, nicaraguae, castaneus, capistratus", "subspecies_variety"]
kobo_clean[kobo_clean$taxon=="Campylorhynchus rufinucha humilis, rufinucha, nigricaudatus, xerophilus, nicaraguae, castaneus, capistratus", "subspecies_variety"] <-""
kobo_clean[kobo_clean$taxon=="Campylorhynchus rufinucha humilis, rufinucha, nigricaudatus, xerophilus, nicaraguae, castaneus, capistratus", "taxon"] <- "Campylorhynchus rufinucha"
kobo_clean[kobo_clean$taxon=="Campylorhynchus rufinucha", c("subspecies_variety", "species", "taxon")] 

# Icterus Icterus gularis gularis, tamaulipensis, yucatanensis, flavescens, troglodytes,  gigas
kobo_clean[kobo_clean$taxon=="Icterus Icterus gularis gularis, tamaulipensis, yucatanensis, flavescens, troglodytes,  gigas", "subspecies_variety"]
kobo_clean[kobo_clean$taxon=="Icterus Icterus gularis gularis, tamaulipensis, yucatanensis, flavescens, troglodytes,  gigas", "subspecies_variety"] <-""
kobo_clean[kobo_clean$taxon=="Icterus Icterus gularis gularis, tamaulipensis, yucatanensis, flavescens, troglodytes,  gigas", "species"]
kobo_clean[kobo_clean$taxon=="Icterus Icterus gularis gularis, tamaulipensis, yucatanensis, flavescens, troglodytes,  gigas", "species"] <-"gularis"
kobo_clean[kobo_clean$taxon=="Icterus Icterus gularis gularis, tamaulipensis, yucatanensis, flavescens, troglodytes,  gigas", "taxon"] <- "Icterus gularis"
kobo_clean[kobo_clean$taxon=="Icterus gularis", c("subspecies_variety", "species", "taxon")] 


# Melanerpes santacruzi grateloupensis, dubius, santacruzi, hughlandi, leei, turneffensis, pauper, insulanus, canescens
kobo_clean[kobo_clean$taxon=="Melanerpes santacruzi grateloupensis, dubius, santacruzi, hughlandi, leei, turneffensis, pauper, insulanus, canescens", "subspecies_variety"]
kobo_clean[kobo_clean$taxon=="Melanerpes santacruzi grateloupensis, dubius, santacruzi, hughlandi, leei, turneffensis, pauper, insulanus, canescens", "subspecies_variety"] <-""
kobo_clean[kobo_clean$taxon=="Melanerpes santacruzi grateloupensis, dubius, santacruzi, hughlandi, leei, turneffensis, pauper, insulanus, canescens", "taxon"] <- "Melanerpes santacruzi"
kobo_clean[kobo_clean$taxon=="Melanerpes santacruzi", c("subspecies_variety", "species", "taxon")] 

# Saltator atriceps atriceps, suffuscus, flavicrissus, peeti, raptor, lacertosus
kobo_clean[kobo_clean$taxon=="Saltator atriceps atriceps, suffuscus, flavicrissus, peeti, raptor, lacertosus", "subspecies_variety"]
kobo_clean[kobo_clean$taxon=="Saltator atriceps atriceps, suffuscus, flavicrissus, peeti, raptor, lacertosus", "subspecies_variety"] <-""
kobo_clean[kobo_clean$taxon=="Saltator atriceps atriceps, suffuscus, flavicrissus, peeti, raptor, lacertosus", "taxon"] <- "Saltator atriceps"
kobo_clean[kobo_clean$taxon=="Saltator atriceps", c("subspecies_variety", "species", "taxon")] 


# Ambuchanania leucobryoides / Ambuchanania leuchbryoides
# Should be Ambuchanania leucobryoides ('co' not 'ch' in species name)
kobo_clean[kobo_clean$taxon=="Ambuchanania leuchbryoides", "species"]
kobo_clean[kobo_clean$taxon=="Ambuchanania leuchbryoides", "species"] <-"leucobryoides"
kobo_clean[kobo_clean$taxon=="Ambuchanania leuchbryoides", "taxon"] <-"Ambuchanania leucobryoides"
kobo_clean[kobo_clean$taxon=="Ambuchanania leucobryoides", c("species", "taxon")] 


```

Correct:

```{r}
ok_taxon_name<-c("Coregonus albula morphotype trybomi",
                 "Glyptemys muhlenbergii Northern Population")
```

### and object with all taxon names issues together

If there are any remaining taxa with weird taxon names put them together in a single object.

```{r}
check_taxon_names <- kobo_clean %>% 
  filter(grepl(" ", genus) | 
         grepl(" ", species) | 
         grepl(" ", subspecies_variety)) %>%
   filter(!grepl("var.", subspecies_variety)) %>%
   filter(!grepl("subsp.", subspecies_variety)) %>%
   filter(taxon %!in% ok_taxon_name) %>%
  # show only relevant columns
            select(country_assessment, name_assessor, taxon, genus, species, subspecies_variety, end) %>%
       mutate(need_to_check="check genus, species or subspecies_variety, we are targeting to have single words in each field, except in the ifraspecific names, where 'var.' and 'subsp.' (only) would be accepted. Other details or taxonomic notes should be added in the comments.")
check_taxon_names
```

## Create a single file of pending issues for assessors review:

If there are still taxa that need to be checked for whatever reason, write a file enlisting them

```{r}
to_check<-full_join(check_n_pops, check_GBIF) %>% full_join(check_taxon_names) %>%
  # show columns in desired order:
select(country_assessment, name_assessor, taxon, need_to_check, n_extant_populations,
         n_extint_populations, GBIF_taxonID, genus, species, subspecies_variety, end)

to_check

# save file with a list of taxa if there are remaining issues, or with a message saying that all is done if not):

if(nrow(to_check)>0) {

write.csv(to_check, "kobo_output_tocheck_remaining_issues.csv", row.names = FALSE, fileEncoding = "UTF-8")
} else {
happy_message<-"congratulations! there are no more taxa with issues to be corrected. :)"
 write.csv(happy_message, "kobo_output_tocheck_remaining_issues.csv", row.names = FALSE, fileEncoding = "UTF-8")
}

```

## Save the clean koboutput version:

Remove from the clean version any remaining taxa with issues

```{r}
kobo_clean<-kobo_clean %>%
            filter(taxon %!in% to_check$taxon)
```

Export clean version

```{r}
write.csv(kobo_clean, "kobo_output_clean.csv", row.names = FALSE, fileEncoding = "UTF-8")
```

## Check and if needed correct population data provided in the templates

If information of more than 25 populations was be used to collect data for Ne >500 indicator (Section 5 of the Kobo form), it is possible to use a template to upload data instead of using the kobo form. This section of the cleaning script processes those files to create a single clean object as expected to estimate indicator 1 (Ne >500).

### Get files 

The function below parses kobo attachments directories to look for files with population data, matches them against their metadata (captured in kobo) and stores them in an target directory.

```{r}
source("get_attached_files.R")

target_dir = "processed_templates" # directory were the processed templates will be written

# run function
get_attached_files(root_dir = "attachments_2023_08_23", # the directory after unziping the kobo attachments download  
                  target_dir = target_dir, # directory were the processed templates will be written
                  kobo_output = kobo_clean)

```

Check which files were saved:

```{r}
result_files<-list.files(target_dir) %>% 
  str_subset("^(?!file_names\\.txt$).*\\.txt$") # exclude the file "file_names.txt"
result_files
```
How many?
```{r}
length(result_files)
```

How many files were expected based on the kobo_output answers?

```{r}
expected<-kobo_clean %>% 
               filter(taxon %!in% to_check$taxon) %>% 
               filter(kobo_tabular=="tabular") %>% 
               select(country_assessment, name_assessor, taxon, X_uuid, map_populations_URL, end)

nrow(expected)
```

From which country(ies)?
```{r}
table(expected$country_assessment)
```

Which are the missing files?
```{r}
missing<-expected[expected$X_uuid %!in% str_match(result_files, "_([0-9a-f-]{36})\\.txt"),]
missing
```

How many files were sent to  No_coincidence? (This likely means that the species assessment was corrected in kobo and the system does not delete the old file. But we can manually check each file if we are unsure):

```{r}
list.files(paste0(target_dir,"/No_coincidence"))
```


### Check and, if needed clean attachment data.

```{r}

  
source("process_attached_files.R")

# files separated by "\t": australia, france, japan, US
df<-data.frame()
for(i in result_files[c(1:2, 16:17, 18:20, 21:24)]){ # change numbers to reflect files with the desired delim
  file<-paste0(target_dir,"/", i)
  cat(paste("##     processing file: \n",
            "    ", file, " \n", " \n"))
  temp<-process_attached_files(file_path=file, kobo_output=kobo_clean, delim = '\t')
  df<-rbind(df, temp)
  cat(" \n")
}

## files separated by ";" belgium 
for(i in result_files[c(3:15)]){
  file<-paste0(target_dir,"/", i)
  cat(paste("##     processing file: \n",
            "    ", file, " \n", " \n"))
  temp<-process_attached_files(file_path=file, kobo_output=kobo_clean, delim = ";")
  df<-rbind(df, temp)
  cat(" \n")
}
  
```



## Session Info for reproducibility purposes:

```{r}
sessionInfo()
```


