---
title: "Data exploration and cleaning"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

This notebook looks for common sources of error to make sure it is ready for data analyses. Typos and small errors are corrected in a reproducible way, other error that need manual revision are flagged so that assessors can review them. 

The output are:

* a file showing the records that need manual review or corrections, if any
* a clean kobo file that can be used for analyses.

## Get data

Load required libraries:

```{r, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
library(utile.tools)
library(stringr)
library(ggplot2)
```

Get Kobo raw output data:
```{r}
kobo_output<-read.csv(file="International_Genetic_Indicator_testing_V_4.0_-_latest_version_-_False_-_2023-04-30-07-43-42.csv", sep=";", header=TRUE) %>%

## add  taxon column
mutate(taxon=(utile.tools::paste(genus, species, subspecies_variety, na.rm=TRUE))) %>%
    # remove white space at the end of the name
    mutate(taxon=str_trim(taxon, "right"))

```

Filter out records which were marked as "not_approved" in the manual Kobo validation interface (this means country assessors determined the is something wrong with that particular record).

```{r}
# check if any species is flagged as "validation_status_not_approved"
kobo_output %>%
      filter(X_validation_status=="validation_status_not_approved")

# omit those records from data:
kobo_output<- kobo_output %>%
            filter(X_validation_status!="validation_status_not_approved")

```


## Check for common data capture errors

### Number of populations

In the form, -999 was used to mark taxa with unknown number of extant populations. This was used because answering the question was mandatory, so leaving it blank wasn't possible. We have to change -999 to NA.

```{r}
kobo_output<-kobo_output %>%
             mutate(n_extant_populations= na_if(n_extant_populations, -999))
```


We can now explore how many populations per species are still extant (still existing! NOT extinct!)?

```{r}
summary(kobo_output$n_extant_populations)
table(kobo_output$n_extant_populations)
```

Plot histogram
```{r}
ggplot(kobo_output, aes(x=n_extant_populations))+
      geom_histogram()
```

Zoom Plot histogram
```{r}
kobo_output %>%
    filter(n_extant_populations>=0, n_extant_populations<25) %>%

ggplot(., aes(x=n_extant_populations))+
      geom_histogram()
```

Once -999 was replaced by NA there should be no negative number of populations (if they are, they are typos that need to be corrected).
```{r}
kobo_output %>%
      filter(n_extant_populations<0) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, other_populations)
```

Show which taxa (if any) have 0 (zero) extant populations. **Is this correct? needs to be manually checked**
```{r}
kobo_output %>%
      filter(n_extant_populations==0) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, other_populations)


```

Show which species (if any) have 999 extant populations. **Should this be -999? OR n_extinct pops??**
```{r}
kobo_output %>%
      filter(n_extant_populations==999) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, other_populations)


```

Show which species (if any) have 999 EXTINCT populations. **Should this be -999?**
```{r}
ind2_data %>%
      filter(n_extint_populations==999) %>%
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, other_populations)
```
Put all taxa with weird number of populatins that need to be checked together:

```{r}
check_n_pops <- kobo_output %>% 
      # variables of interest
      select(country_assessment, taxon, name_assessor, n_extant_populations, n_extint_populations, other_populations) %>%

      # same filters that discussed above
      filter(n_extant_populations<0 |
            n_extant_populations==0 | 
            n_extant_populations==999 | 
            n_extint_populations==999) 

```



### Are there any tests?
```{r}
kobo_output[kobo_output$genus=="test", 5:8]

```

### GBIF ID codes

Check GBIF 
```{r}
# check IDs
head(kobo_output$GBIF_taxonID)
```

GBIF IDs tend to be 7 characters long. Some can be larger or shorter, but these seems to be exceptions. Therefore let's flag any records where the GBIF Id is =/= 7 to manually check if it is correct.

```{r}
kobo_output %>%
            filter(nchar(GBIF_taxonID)>0, nchar(GBIF_taxonID)!=7) %>%
  # show only relevant columns
            select(name_assessor, country_assessment, genus, species, GBIF_taxonID)
```


### Species names

Genus, species and subspecies should be a single word, check if there are cases where it isn't:

```{r}
kobo_output %>% 
  filter(grepl(" ", subspecies_variety))



```


Session Info for reproducibility purposes:

```{r}
sessionInfo()
```


